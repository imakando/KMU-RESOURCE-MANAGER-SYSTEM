


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin & Supervisor System (Firebase Enabled)</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap');
        body {
            font-family: 'Roboto Mono', monospace;
            background-color: #1a1a1a;
            color: #00ff00;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 2rem;
            box-sizing: border-box;
        }
        .container {
            width: 100%;
            max-width: 1200px;
        }
        .system-panel {
            background-color: #000000;
            border: 2px solid #00ff00;
            box-shadow: 0 0 10px #00ff00;
            padding: 2rem;
            margin-bottom: 2rem;
            animation: terminalGlow 2s infinite alternate;
        }
        @keyframes terminalGlow {
            from { box-shadow: 0 0 5px #00ff00; }
            to { box-shadow: 0 0 15px #00ff00; }
        }
        .login-card {
            max-width: 500px;
            margin: 0 auto;
        }
        input, select, textarea {
            background-color: #0d0d0d;
            border: 1px solid #00ff00;
            color: #00ff00;
            padding: 0.75rem;
            width: 100%;
            margin-top: 0.5rem;
            margin-bottom: 1rem;
            box-shadow: inset 0 0 5px #00ff0080;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            box-shadow: 0 0 10px #00ff00;
        }
        button {
            background-color: #00aaff;
            color: #000000;
            font-weight: bold;
            padding: 0.75rem 1.5rem;
            border: 2px solid #00aaff;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        button.btn-primary { background-color: #00aaff; border-color: #00aaff; }
        button.btn-danger { background-color: #ff3333; border-color: #ff3333; }
        button.btn-warning { background-color: #ffff33; border-color: #ffff33; color: #000; }
        button.btn-success { background-color: #00cc00; border-color: #00cc00; }
        button:hover {
            filter: brightness(1.2);
            box-shadow: 0 0 10px;
        }
        .text-neon-blue { color: #00aaff; }
        .text-neon-green { color: #00ff00; }
        .text-neon-red { color: #ff3333; }
        .text-neon-yellow { color: #ffff33; }
        .flex-container {
            display: flex;
            gap: 2rem;
            flex-wrap: wrap;
        }
        .flex-container > div {
            flex: 1;
            min-width: 400px;
        }
        .grid-container {
            display: grid;
            gap: 1rem;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        }
        .station-card {
            border: 1px dashed #00ff00;
            padding: 1rem;
            text-align: center;
        }
        .station-card.occupied {
            border-color: #ff3333;
            background-color: rgba(255, 51, 51, 0.1);
        }
        .station-card.unoccupied {
            border-color: #00cc00;
            background-color: rgba(0, 204, 0, 0.1);
        }
        .station-card.needs-maintenance {
            border-color: #ffff33;
            background-color: rgba(255, 255, 51, 0.1);
        }
        .chat-container {
            height: 300px;
            overflow-y: auto;
            border: 1px solid #00ff00;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .chat-message {
            max-width: 75%;
            padding: 0.5rem;
            border: 1px solid;
        }
        .chat-message.admin {
            align-self: flex-end;
            background-color: rgba(0, 170, 255, 0.2);
            border-color: #00aaff;
        }
        .chat-message.supervisor {
            align-self: flex-start;
            background-color: rgba(0, 204, 0, 0.2);
            border-color: #00cc00;
        }
        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #000;
            border: 2px solid #00ff00;
            box-shadow: 0 0 10px #00ff00;
            padding: 2rem;
            z-index: 1000;
            color: #00ff00;
            display: none;
        }
        .broadcast-message {
            position: fixed;
            top: 1rem;
            left: 50%;
            transform: translateX(-50%);
            background: #ff3333;
            color: #000;
            font-weight: bold;
            padding: 1rem 2rem;
            border: 2px solid #000;
            box-shadow: 0 0 15px #ff3333;
            z-index: 2000;
            display: none;
            animation: pulseGlow 1s infinite alternate;
        }
        @keyframes pulseGlow {
            from { box-shadow: 0 0 5px #ff3333; }
            to { box-shadow: 0 0 20px #ff3333; }
        }
        .report-section {
            background-color: #0d0d0d;
            padding: 1rem;
            border: 1px solid #00ff00;
            margin-top: 1rem;
        }
        .password-strength {
            font-size: 0.8rem;
            margin-top: -0.5rem;
            margin-bottom: 0.5rem;
            text-align: left;
        }
        .password-strength.weak { color: #ff3333; }
        .password-strength.medium { color: #ffff33; }
        .password-strength.strong { color: #00cc00; }
        .blinking-dot {
            height: 10px;
            width: 10px;
            background-color: #ff3333;
            border-radius: 50%;
            display: inline-block;
            margin-left: 5px;
            animation: blink 1s linear infinite;
        }
        @keyframes blink {
            50% { opacity: 0; }
        }
        .kiosk-card {
            background-color: #000000;
            border: 1px solid #00ff00;
            padding: 1rem;
            text-align: center;
        }
        /* New Styles for Supervisor Buttons */
        .supervisor-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            margin-top: 0.5rem;
        }
        .nav-bar {
            background-color: #0d0d0d;
            border-bottom: 2px solid #00ff00;
            padding: 1rem;
            display: flex;
            justify-content: flex-start;
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .nav-link {
            text-decoration: none;
            color: #00aaff;
            font-weight: bold;
            padding: 0.5rem 1rem;
            border: 1px solid transparent;
            transition: all 0.3s ease;
        }
        .nav-link:hover {
            border-color: #00aaff;
            color: #00ffff;
        }
        .top-button-container {
            text-align: right;
            margin-top: 1rem;
        }
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .dashboard-header h1 {
            font-size: 2rem;
            font-weight: bold;
            color: #00ff00;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="broadcast-message" class="broadcast-message">
            <p id="broadcast-text"></p>
            <button onclick="dismissBroadcast()" style="background: #000; color: #ff3333; border-color: #ff3333;">DISMISS</button>
        </div>

        <div id="login-screen" class="system-panel login-card">
            <h1 class="text-neon-green text-3xl font-bold mb-4 text-center">ACCESS TERMINAL</h1>
            <p id="welcome-message" class="text-center text-neon-green mb-4"></p>
            <div class="flex flex-col items-center mb-6">
                 <div class="p-4 rounded-full mb-2 border-2 border-dashed border-neon-green">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#00ff00" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-terminal-square"><path d="m7 11 2 2 4-4"/><rect width="18" height="18" x="3" y="3" rx="2"/></svg>
                 </div>
            </div>
            <div class="flex justify-center mb-8">
                <button id="show-admin-login-btn" class="btn-primary w-1/3">ADMIN</button>
                <button id="show-supervisor-login-btn" class="btn-success w-1/3">SUPERVISOR</button>
                <button id="show-kiosk-btn" class="btn-warning w-1/3">KIOSK</button>
            </div>
            <form id="admin-login-form">
                <h2 class="text-neon-blue text-center mb-4">ADMIN LOGIN</h2>
                <input type="text" id="admin-username" placeholder="Username" required>
                <input type="password" id="admin-password" placeholder="Password" required>
                <input type="password" id="admin-secret-code" placeholder="Secret Code" required>
                <button type="submit" class="btn-primary w-full">LOG IN</button>
                <p id="admin-login-message" class="text-center text-neon-red mt-2"></p>
            </form>
            <form id="supervisor-login-form" style="display:none;">
                <h2 class="text-neon-green text-center mb-4">SUPERVISOR LOGIN</h2>
                <input type="text" id="supervisor-id" placeholder="ID" required>
                <input type="password" id="supervisor-password" placeholder="Password" required>
                <button type="submit" class="btn-success w-full">LOG IN</button>
                <button type="button" id="forgot-password-btn" class="btn-warning w-full mt-2">FORGOT PASSWORD?</button>
                <p id="supervisor-login-message" class="text-center text-neon-red mt-2"></p>
            </form>
        </div>
        <div id="admin-dashboard" style="display:none;">
            <div class="nav-bar">
                <a href="#admin-user-management-section" class="nav-link">USER MANAGEMENT</a>
                <a href="#admin-register-section" class="nav-link">REGISTRATION</a>
                <a href="#admin-reports-section" class="nav-link">REPORTS</a>
                <a href="#admin-station-status-section" class="nav-link">STATION STATUS</a>
                <a href="#admin-broadcast-section" class="nav-link">BROADCAST</a>
                <a href="#admin-chat-section" class="nav-link">CHAT</a>
            </div>
            <div class="system-panel">
                <div class="dashboard-header">
                    <h1 class="text-neon-blue">ADMIN DASHBOARD</h1>
                    <button id="admin-logout-btn" class="btn-danger">LOGOUT</button>
                </div>
                <div id="on-duty-section" class="flex-container mt-4">
                    <div class="system-panel">
                        <h3 class="text-neon-blue text-xl font-bold">SUPERVISOR ON DUTY</h3>
                        <div id="on-duty-supervisor" class="text-neon-green">
                            <p>None</p>
                        </div>
                    </div>
                    <div class="system-panel">
                        <h3 class="text-neon-blue text-xl font-bold">LAST ASSIGNMENT</h3>
                        <div id="last-assignment" class="text-neon-green">
                            <p>None</p>
                        </div>
                    </div>
                </div>

                <div id="admin-register-section" class="flex-container mt-4">
                    <div class="system-panel">
                        <h2 class="text-neon-blue text-2xl font-bold mb-4">REGISTER STUDENT</h2>
                        <div class="top-button-container">
                            <button onclick="scrollToTop()" class="btn-primary">BACK TO TOP</button>
                        </div>
                        <form id="student-register-form">
                            <input type="text" id="student-name" placeholder="Student Name" required>
                            <input type="text" id="student-id" placeholder="Student ID" required>
                            <input type="text" id="student-hostel" placeholder="Hostel.Room" required>
                            <input type="text" id="student-program" placeholder="Program of Study" required>
                            <input type="number" id="student-year" placeholder="Year of Study" required>
                            <label class="text-neon-green">PHOTO UPLOAD</label>
                            <input type="file" id="student-photo">
                            <button type="submit" class="btn-primary w-full mt-4">REGISTER</button>
                            <p id="student-register-message" class="text-center mt-2"></p>
                        </form>
                    </div>
                    <div class="system-panel">
                        <h2 class="text-neon-blue text-2xl font-bold mb-4">REGISTER SUPERVISOR</h2>
                        <div class="top-button-container">
                            <button onclick="scrollToTop()" class="btn-primary">BACK TO TOP</button>
                        </div>
                        <form id="supervisor-register-form">
                            <input type="text" id="supervisor-name" placeholder="Supervisor Name" required>
                            <input type="text" id="supervisor-reg-id" placeholder="ID" required>
                            <input type="email" id="supervisor-email" placeholder="Email" required>
                            <input type="password" id="supervisor-reg-password" placeholder="Password" required>
                            <div id="supervisor-password-strength" class="password-strength"></div>
                            <label class="text-neon-green">PHOTO UPLOAD</label>
                            <input type="file" id="supervisor-photo">
                            <button type="submit" class="btn-primary w-full mt-4">REGISTER</button>
                            <p id="supervisor-register-message" class="text-center mt-2"></p>
                        </form>
                    </div>
                </div>
                <div id="admin-user-management-section" class="system-panel mt-4">
                    <div class="dashboard-header">
                        <h2 class="text-neon-blue text-2xl font-bold">USER MANAGEMENT</h2>
                        <div class="top-button-container">
                            <button onclick="scrollToTop()" class="btn-primary">BACK TO TOP</button>
                        </div>
                    </div>
<!-- SEARCH REMOVED BY REQUEST -->
<div id="user-list"></div>
                </div>
                <div id="admin-reports-section" class="system-panel mt-4">
                    <div class="dashboard-header">
                        <h2 class="text-neon-blue text-2xl font-bold">SYSTEM ACTIVITIES & REPORTS</h2>
                        <div class="top-button-container">
                            <button onclick="scrollToTop()" class="btn-primary">BACK TO TOP</button>
                        </div>
                    </div>
                    <div class="flex-container">
                        <div class="system-panel">
                            <h3 class="text-xl text-neon-green">ACTIVITY LOG</h3>
                            <ul id="activity-log" style="height: 150px; overflow-y: auto;"></ul>
                        </div>
                        <div class="system-panel">
                            <h3 class="text-xl text-neon-green">REPORT SUMMARY</h3>
                            <p>TOTAL SUPERVISORS: <span id="report-supervisors">0</span></p>
                            <p>TOTAL STUDENTS: <span id="report-students">0</span></p>
                            <p>TOTAL STATIONS: <span id="report-total-stations">0</span></p>
                            <p>OCCUPIED STATIONS: <span id="report-occupied-stations">0</span></p>
                            <p>UNOCCUPIED STATIONS: <span id="report-unoccupied-stations">0</span></p>
                            <button onclick="generateReport()" class="btn-success mt-2">GENERATE REPORT</button>
                        </div>
                    </div>
                </div>
                <div class="system-panel mt-4">
                    <h2 class="text-neon-blue text-2xl font-bold mb-4">CUSTOM REPORTS</h2>
                    <div class="top-button-container">
                        <button onclick="scrollToTop()" class="btn-primary">BACK TO TOP</button>
                    </div>
                    <form id="custom-report-form">
                        <label for="report-start-date" class="text-neon-green">Start Date:</label>
                        <input type="date" id="report-start-date">
                        <label for="report-end-date" class="text-neon-green">End Date:</label>
                        <input type="date" id="report-end-date">
                        <label class="text-neon-green">Select Metrics:</label>
                        <div style="display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 1rem;">
                            <label><input type="checkbox" name="metric" value="mostUsed" checked> Most Used Stations</label>
                            <label><input type="checkbox" name="metric" value="leastUsed" checked> Least Used Stations</label>
                            <label><input type="checkbox" name="metric" value="averageSession"> Average Session Time</label>
                        </div>
                        <button type="submit" class="btn-primary w-full">GENERATE CUSTOM REPORT</button>
                    </form>
                    <div id="custom-report-output" class="report-section" style="display: none;"></div>
                </div>
                <div id="admin-station-status-section" class="system-panel mt-4">
                    <h2 class="text-neon-blue text-2xl font-bold mb-4">STATION STATUS</h2>
                    <div class="top-button-container">
                        <button onclick="scrollToTop()" class="btn-primary">BACK TO TOP</button>
                    </div>
                    <div id="station-status-admin" class="grid-container"></div>
                </div>
                <div id="admin-broadcast-section" class="system-panel mt-4">
                    <h2 class="text-neon-blue text-2xl font-bold mb-4">EMERGENCY BROADCAST</h2>
                    <div class="top-button-container">
                        <button onclick="scrollToTop()" class="btn-primary">BACK TO TOP</button>
                    </div>
                    <form id="broadcast-form">
                        <textarea id="broadcast-message-input" placeholder="Type urgent message here..." rows="2" required></textarea>
                        <button type="submit" class="btn-danger w-full mt-2">SEND BROADCAST</button>
                    </form>
                </div>
                <div id="admin-chat-section" class="system-panel mt-4">
                    <div class="dashboard-header">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <h2 class="text-neon-blue text-2xl font-bold">CHAT WITH SUPERVISORS</h2>
                            <span id="admin-chat-notification" class="blinking-dot" style="display:none;"></span>
                        </div>
                        <div class="top-button-container">
                            <button onclick="scrollToTop()" class="btn-primary">BACK TO TOP</button>
                        </div>
                    </div>
                    <div id="admin-chat-box" class="chat-container"></div>
                    <form id="admin-chat-form" style="display:flex; gap: 1rem; margin-top: 1rem;">
                        <input type="text" id="admin-chat-input" placeholder="> TYPE MESSAGE..." style="flex-grow: 1;" required>
                        <button type="submit" class="btn-primary">SEND</button>
                    </form>
                </div>
            </div>
        </div>
        <div id="supervisor-dashboard" style="display:none;">
            <div class="nav-bar">
                <a href="#supervisor-assign-section" class="nav-link">ASSIGN STATION</a>
                <a href="#supervisor-station-status-section" class="nav-link">STATION STATUS</a>
                <a href="#supervisor-reports-section" class="nav-link">REPORT ISSUE</a>
                <a href="#supervisor-chat-section" class="nav-link">CHAT WITH ADMIN</a>
            </div>
            <div class="system-panel">
                <div class="dashboard-header">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <div id="supervisor-profile-photo" style="width: 48px; height: 48px; border-radius: 50%; border: 1px dashed #00ff00; overflow: hidden; display: flex; align-items: center; justify-content: center; background: #333;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#00ff00" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                        </div>
                        <h1 class="text-neon-green" id="supervisor-dashboard-title">SUPERVISOR DASHBOARD</h1>
                    </div>
                    <div style="display:flex; gap: 1rem;">
                        <button id="supervisor-change-password-btn" class="btn-primary">CHANGE PASSWORD</button>
                        <button id="supervisor-logout-btn" class="btn-danger">LOGOUT</button>
                    </div>
                </div>
                <div id="supervisor-assign-section" class="flex-container mt-4">
                    <div class="system-panel">
                        <h2 class="text-neon-green text-2xl font-bold mb-4">ASSIGN STATION</h2>
                        <div class="top-button-container">
                            <button onclick="scrollToTop()" class="btn-primary">BACK TO TOP</button>
                        </div>
                        <form id="station-assignment-form">
                            <select id="station-select" required>
                                <option value="">SELECT A STATION</option>
                            </select>
                            <input type="text" id="student-lookup-input" placeholder="ENTER STUDENT ID OR NAME" required>
                            <div id="student-profile-preview" style="display: none; align-items: center; gap: 1rem; margin-top: 1rem;">
                                <img id="student-photo-preview" src="" alt="Student Photo" style="width: 64px; height: 64px; border-radius: 50%; object-fit: cover; border: 1px dashed #00ff00;">
                                <div id="student-details-preview"></div>
                            </div>
                            <label class="text-neon-green">Session Duration (minutes)</label>
                            <input type="number" id="session-duration" placeholder="e.g., 60" min="15" value="60" required>
                            <p id="station-assignment-message" class="text-center mt-2"></p>
                            <button type="submit" class="btn-success w-full mt-4">ASSIGN STATION</button>
                        </form>
                    </div>
                    <div id="supervisor-station-status-section" class="system-panel">
                        <h2 class="text-neon-green text-2xl font-bold mb-4">STATION STATUS</h2>
                        <div class="top-button-container">
                            <button onclick="scrollToTop()" class="btn-primary">BACK TO TOP</button>
                        </div>
                        <div id="station-status-supervisor" class="grid-container"></div>
                    </div>
                </div>
                <div id="supervisor-reports-section" class="flex-container mt-4">
                    <div class="system-panel">
                        <h2 class="text-neon-green text-2xl font-bold mb-4">REPORT STATION ISSUES</h2>
                        <div class="top-button-container">
                            <button onclick="scrollToTop()" class="btn-primary">BACK TO TOP</button>
                        </div>
                        <form id="issue-report-form">
                            <select id="issue-station-select" required>
                                <option value="">SELECT STATION</option>
                            </select>
                            <select id="issue-type" required>
                                <option value="">SELECT ISSUE TYPE</option>
                                <option value="Needs Maintenance">Needs Maintenance</option>
                                <option value="Out of Service">Out of Service</option>
                            </select>
                            <textarea id="issue-description" placeholder="DESCRIBE THE ISSUE..." rows="4" required></textarea>
                            <button type="submit" class="btn-warning w-full mt-4">REPORT ISSUE</button>
                        </form>
                    </div>
                    <div id="supervisor-chat-section" class="system-panel">
                        <div class="dashboard-header">
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <h2 class="text-neon-green text-2xl font-bold">CHAT WITH ADMIN</h2>
                                <span id="supervisor-chat-notification" class="blinking-dot" style="display:none;"></span>
                            </div>
                            <div class="top-button-container">
                                <button onclick="scrollToTop()" class="btn-primary">BACK TO TOP</button>
                            </div>
                        </div>
                        <div id="supervisor-chat-box" class="chat-container"></div>
                        <form id="supervisor-chat-form" style="display:flex; gap: 1rem; margin-top: 1rem;">
                            <input type="text" id="supervisor-chat-input" placeholder="> REPLY TO ADMIN..." style="flex-grow: 1;" required>
                            <button type="submit" class="btn-success">REPLY</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <div id="kiosk-screen" style="display:none;">
            <div class="system-panel">
                <div class="dashboard-header">
                    <h1 class="text-neon-yellow text-3xl font-bold">STUDENT KIOSK</h1>
                    <button id="kiosk-back-btn" class="btn-warning">BACK TO LOGIN</button>
                </div>
                <div class="system-panel mt-4">
                    <h2 class="text-neon-yellow text-2xl font-bold mb-4">STATION STATUS OVERVIEW</h2>
                    <div class="top-button-container">
                        <button onclick="scrollToTop()" class="btn-primary">BACK TO TOP</button>
                    </div>
                    <div id="kiosk-station-list" class="grid-container"></div>
                </div>
            </div>
        </div>
        <div id="password-reset-modal" class="message-box">
            <h3 class="text-neon-yellow text-2xl mb-4">RESET PASSWORD</h3>
            <form id="password-reset-form">
                <input type="text" id="reset-name" placeholder="Name" required>
                <input type="text" id="reset-id" placeholder="ID" required>
                <input type="password" id="reset-old-password" placeholder="Current Password" required>
                <input type="password" id="reset-new-password" placeholder="New Password" required>
                <button type="submit" class="btn-warning w-full mt-4">RESET PASSWORD</button>
                <button type="button" id="cancel-reset-btn" class="btn-danger w-full mt-2">CANCEL</button>
                <p id="reset-message" class="text-center text-neon-red mt-2"></p>
            </form>
        </div>
        <div id="password-change-modal" class="message-box">
            <h3 class="text-neon-blue text-2xl mb-4">CHANGE PASSWORD</h3>
            <form id="password-change-form">
                <input type="password" id="current-password" placeholder="Current Password" required>
                <input type="password" id="new-password" placeholder="New Password" required>
                <div id="new-password-strength" class="password-strength"></div>
                <button type="submit" class="btn-primary w-full mt-4">CHANGE PASSWORD</button>
                <button type="button" id="cancel-change-btn" class="btn-danger w-full mt-2">CANCEL</button>
                <p id="change-password-message" class="text-center text-neon-red mt-2"></p>
            </form>
        </div>
        <div id="user-detail-modal" class="message-box" style="max-width: 600px;">
            <h3 class="text-neon-blue text-2xl mb-4" id="user-modal-title"></h3>
            <form id="edit-user-form">
                <div id="user-modal-content"></div>
                <button type="submit" class="btn-primary w-full mt-4">SAVE CHANGES</button>
                <button type="button" onclick="closeModal('user-detail-modal')" class="btn-danger w-full mt-2">CLOSE</button>
            </form>
        </div>
    </div>

    <script>
         // ---------- Firebase Configuration ----------
        const firebaseConfig = {
          apiKey: "AIzaSyDrjo_HDQ1RRkjA-zXgZtuFovI7zg2yma0",
          authDomain: "kmu-digita-rsc-mnt-system.firebaseapp.com",
          databaseURL: "https://kmu-digita-rsc-mnt-system-default-rtdb.firebaseio.com",
          projectId: "kmu-digita-rsc-mnt-system",
          storageBucket: "kmu-digita-rsc-mnt-system.appspot.com",
          messagingSenderId: "908284620214",
          appId: "1:908284620214:web:e76e9a4757c162eea1a517",
          measurementId: "G-JEPQ1YMVNE"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();
        // ---------- Local state (minimal) ----------
        let currentUser = null; // { uid, role, name, id }
        let adminSettings = null; // loaded from meta/adminSettings doc

        // ---------- UI references ----------
        const loginScreen = document.getElementById('login-screen');
        const adminDashboard = document.getElementById('admin-dashboard');
        const supervisorDashboard = document.getElementById('supervisor-dashboard');
        const kioskScreen = document.getElementById('kiosk-screen');
        const adminLoginForm = document.getElementById('admin-login-form');
        const supervisorLoginForm = document.getElementById('supervisor-login-form');
        const showAdminLoginBtn = document.getElementById('show-admin-login-btn');
        const showSupervisorLoginBtn = document.getElementById('show-supervisor-login-btn');
        const showKioskBtn = document.getElementById('show-kiosk-btn');
        const kioskBackBtn = document.getElementById('kiosk-back-btn');
        const adminLoginMessage = document.getElementById('admin-login-message');
        const supervisorLoginMessage = document.getElementById('supervisor-login-message');
        const passwordResetModal = document.getElementById('password-reset-modal');
        const forgotPasswordBtn = document.getElementById('forgot-password-btn');
        const passwordResetForm = document.getElementById('password-reset-form');
        const cancelResetBtn = document.getElementById('cancel-reset-btn');
        const studentRegisterForm = document.getElementById('student-register-form');
        const supervisorRegisterForm = document.getElementById('supervisor-register-form');
        const supervisorRegPasswordInput = document.getElementById('supervisor-reg-password');
        const supervisorPasswordStrength = document.getElementById('supervisor-password-strength');
        const studentRegisterMessage = document.getElementById('student-register-message');
        const supervisorRegisterMessage = document.getElementById('supervisor-register-message');
        const userList = document.getElementById('user-list');
        const userSearchInput = document.getElementById('user-search-input');
        const activityLog = document.getElementById('activity-log');
        const stationStatusAdmin = document.getElementById('station-status-admin');
        const adminChatBox = document.getElementById('admin-chat-box');
        const adminChatForm = document.getElementById('admin-chat-form');
        const stationAssignmentForm = document.getElementById('station-assignment-form');
        const stationSelect = document.getElementById('station-select');
        const studentLookupInput = document.getElementById('student-lookup-input');
        const studentLookupMessage = document.getElementById('station-assignment-message');
        const studentProfilePreview = document.getElementById('student-profile-preview');
        const studentPhotoPreview = document.getElementById('student-photo-preview');
        const studentDetailsPreview = document.getElementById('student-details-preview');
        const stationStatusSupervisor = document.getElementById('station-status-supervisor');
        const issueReportForm = document.getElementById('issue-report-form');
        const issueStationSelect = document.getElementById('issue-station-select');
        const supervisorChatBox = document.getElementById('supervisor-chat-box');
        const supervisorChatForm = document.getElementById('supervisor-chat-form');
        const passwordChangeModal = document.getElementById('password-change-modal');
        const supervisorChangePasswordBtn = document.getElementById('supervisor-change-password-btn');
        const passwordChangeForm = document.getElementById('password-change-form');
        const cancelChangeBtn = document.getElementById('cancel-change-btn');
        const newPasswordInput = document.getElementById('new-password');
        const newPasswordStrength = document.getElementById('new-password-strength');
        const supervisorProfilePhoto = document.getElementById('supervisor-profile-photo');
        const supervisorDashboardTitle = document.getElementById('supervisor-dashboard-title');
        const welcomeMessage = document.getElementById('welcome-message');
        const broadcastMessageEl = document.getElementById('broadcast-message');
        const broadcastTextEl = document.getElementById('broadcast-text');
        const customReportForm = document.getElementById('custom-report-form');
        const customReportOutput = document.getElementById('custom-report-output');
        const broadcastForm = document.getElementById('broadcast-form');
        const userDetailModal = document.getElementById('user-detail-modal');
        const userModalTitle = document.getElementById('user-modal-title');
        const userModalContent = document.getElementById('user-modal-content');
        const kioskStationList = document.getElementById('kiosk-station-list');
        const adminChatNotification = document.getElementById('admin-chat-notification');
        const supervisorChatNotification = document.getElementById('supervisor-chat-notification');

        // ---------- Utility functions ----------
        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        function updateWelcomeMessage() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' };
            welcomeMessage.textContent = `SYSTEM ACCESS. CURRENT TIME: ${now.toLocaleDateString('en-US', options)}`;
        }
        function showScreen(screenId) {
            loginScreen.style.display = 'none';
            adminDashboard.style.display = 'none';
            supervisorDashboard.style.display = 'none';
            kioskScreen.style.display = 'none';
            document.getElementById(screenId).style.display = 'block';
            if (screenId === 'kiosk-screen') {
                // kiosk list updates from realtime listener
            }
        }
        
        // Navigation for dashboards
        document.querySelectorAll('.nav-bar a').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const targetId = e.target.getAttribute('href').substring(1);
                const targetElement = document.getElementById(targetId);
                if (targetElement) {
                    targetElement.scrollIntoView({ behavior: 'smooth' });
                }
            });
        });

        // ---------- Initial seeding & listeners ----------
        async function ensureAdminSettings() {
            const docRef = db.collection('meta').doc('adminSettings');
            const doc = await docRef.get();
            if (!doc.exists) {
                // create default admin settings. You should update secret code & admin email via Firestore console
                await docRef.set({
                    email: 'admin@kmu.edu',
                    username: 'Admin',
                    secretCode: '12345'
                });
            }
            adminSettings = (await docRef.get()).data();
        }

        async function ensureStationsExist(count = 100) {
            const stationsRef = db.collection('stations');
            const snapshot = await stationsRef.limit(1).get();
            if (snapshot.empty) {
                // create stations 1..count
                const batch = db.batch();
                for (let i = 1; i <= count; i++) {
                    const sRef = stationsRef.doc(String(i));
                    batch.set(sRef, {
                        id: i,
                        isOccupied: false,
                        assignedTo: null,
                        assignedBy: null,
                        issue: null,
                        sessionEndTime: null,
                        sessionDuration: null,
                        statusFlag: null
                    });
                }
                await batch.commit();
            }
        }

        // realtime listeners (students, supervisors, stations, chats, activities)
        let studentsCache = [];
        let supervisorsCache = [];
        function attachRealtimeListeners() {
            db.collection('students').onSnapshot(snapshot => {
                studentsCache = [];
                snapshot.forEach(doc => studentsCache.push({ id: doc.id, ...doc.data() }));
                renderUserList();
            });
            db.collection('supervisors').onSnapshot(snapshot => {
                supervisorsCache = [];
                snapshot.forEach(doc => supervisorsCache.push({ id: doc.id, ...doc.data() }));
                renderUserList();
                renderSupervisorProfile();
            });
            db.collection('stations').onSnapshot(snapshot => {
                // transform into array of stations sorted by id
                const stations = [];
                snapshot.forEach(doc => stations.push({ id: Number(doc.id), ...doc.data() }));
                stations.sort((a,b) => a.id - b.id);
                window._stationsCache = stations;
                renderStationStatusAdmin();
                renderStationStatusSupervisor();
                renderStationSelectors();
                renderKioskStations();
                updateReportCounts();
            });
            db.collection('chats').orderBy('time').onSnapshot(snapshot => {
                const messages = [];
                snapshot.forEach(doc => messages.push({ id: doc.id, ...doc.data() }));
                window._chatsCache = messages;
                renderChat(adminChatBox, 'admin');
                renderChat(supervisorChatBox, 'supervisor');
            });
            db.collection('activities').orderBy('time', 'desc').limit(50).onSnapshot(snapshot => {
                activityLog.innerHTML = '';
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const li = document.createElement('li');
                    const timeStr = new Date(data.time).toLocaleTimeString();
                    li.textContent = `[${timeStr}] ${data.message}`;
                    activityLog.prepend(li);
                });
            });
            // listen for broadcast message
            db.collection('meta').doc('broadcast').onSnapshot(doc => {
                if (doc.exists) {
                    const data = doc.data();
                    if (data && data.message) {
                        broadcastTextEl.textContent = data.message;
                        broadcastMessageEl.style.display = 'block';
                    } else {
                        broadcastMessageEl.style.display = 'none';
                    }
                } else {
                    broadcastMessageEl.style.display = 'none';
                }
            });
        }

        // ---------- Authentication & Login flows ----------
        showAdminLoginBtn.addEventListener('click', () => toggleLoginForms('admin'));
        showSupervisorLoginBtn.addEventListener('click', () => toggleLoginForms('supervisor'));
        showKioskBtn.addEventListener('click', () => showScreen('kiosk-screen'));
        kioskBackBtn.addEventListener('click', () => showScreen('login-screen'));

        function toggleLoginForms(formToShow) {
            const adminLogin = document.getElementById('admin-login-form');
            const supervisorLogin = document.getElementById('supervisor-login-form');
            const adminBtn = document.getElementById('show-admin-login-btn');
            const supervisorBtn = document.getElementById('show-supervisor-login-btn');
            if (formToShow === 'admin') {
                adminLogin.style.display = 'block';
                supervisorLogin.style.display = 'none';
                adminBtn.style.backgroundColor = '#00aaff';
                supervisorBtn.style.backgroundColor = '#00cc00';
            } else {
                supervisorLogin.style.display = 'block';
                adminLogin.style.display = 'none';
                supervisorBtn.style.backgroundColor = '#00aaff';
                adminBtn.style.backgroundColor = '#00cc00';
            }
        }
        
        adminLoginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            adminLoginMessage.textContent = '';
            const username = e.target['admin-username'].value.trim();
            const password = e.target['admin-password'].value;
            const secretCodeInput = e.target['admin-secret-code'].value.trim();
            try {
                const settingsRef = db.collection('meta').doc('adminSettings');
                const settingsDoc = await settingsRef.get();
                if (!settingsDoc.exists) {
                    adminLoginMessage.textContent = 'ADMIN SETTINGS NOT CONFIGURED. CHECK FIRESTORE meta/adminSettings.';
                    return;
                }
                adminSettings = settingsDoc.data();
                // check username and secret code, then sign in using the stored email
                if (username !== adminSettings.username) {
                    adminLoginMessage.textContent = 'INVALID USERNAME.';
                    return;
                }
                if (secretCodeInput !== String(adminSettings.secretCode)) {
                    adminLoginMessage.textContent = 'INVALID SECRET CODE.';
                    return;
                }
                // sign in with Firebase Auth using admin email
                await auth.signInWithEmailAndPassword(adminSettings.email, password);
                currentUser = { role: 'admin', uid: auth.currentUser.uid, name: adminSettings.username };
                showScreen('admin-dashboard');
                attachRealtimeListeners();
                logActivity('Admin logged in.');
            } catch (err) {
                console.error(err);
                adminLoginMessage.textContent = err.message || 'LOGIN FAILED.';
            }
        });

        supervisorLoginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            supervisorLoginMessage.textContent = '';
            const id = e.target['supervisor-id'].value.trim();
            const password = e.target['supervisor-password'].value;
            try {
                // find supervisor document by ID (we store supervisor reg-id in doc.id field)
                const supDoc = await db.collection('supervisors').doc(id).get();
                if (!supDoc.exists) {
                    supervisorLoginMessage.textContent = 'INVALID ID OR PASSWORD.';
                    return;
                }
                const sup = supDoc.data();
                if (sup.isBlocked) {
                    supervisorLoginMessage.textContent = 'THIS ACCOUNT IS BLOCKED. CONTACT ADMIN.';
                    return;
                }
                // We require supervisors to have an auth account (created at registration)
                if (!sup.authUid) {
                    supervisorLoginMessage.textContent = 'SUPERVISOR AUTH ACCOUNT NOT FOUND. CONTACT ADMIN.';
                    return;
                }
                // attempt sign in using their auth email stored
                await auth.signInWithEmailAndPassword(sup.email, password);
                currentUser = { role: 'supervisor', uid: auth.currentUser.uid, id: id, name: sup.name };
                supervisorDashboardTitle.textContent = `SUPERVISOR ON DUTY: ${sup.name}`;
                showScreen('supervisor-dashboard');
                attachRealtimeListeners();
                logActivity(`Supervisor ${sup.name} logged in.`);
            } catch (err) {
                console.error(err);
                supervisorLoginMessage.textContent = err.message || 'LOGIN FAILED.';
            }
        });

        // logout handlers
        document.getElementById('admin-logout-btn').addEventListener('click', async () => {
            await auth.signOut();
            currentUser = null;
            showScreen('login-screen');
            logActivity('Admin logged out.');
        });
        document.getElementById('supervisor-logout-btn').addEventListener('click', async () => {
            await auth.signOut();
            logActivity(`Supervisor logged out.`);
            db.collection('meta').doc('onDutySupervisor').set({});
            currentUser = null;
            showScreen('login-screen');
        });

        // ---------- Register student (upload photo to storage, save to Firestore) ----------
        studentRegisterForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            studentRegisterMessage.textContent = '';
            const name = e.target['student-name'].value.trim();
            const id = e.target['student-id'].value.trim();
            const hostel = e.target['student-hostel'].value.trim();
            const program = e.target['student-program'].value.trim();
            const year = e.target['student-year'].value;
            const photoFile = document.getElementById('student-photo').files[0];
            try {
                const studentRef = db.collection('students').doc(id);
                const exists = (await studentRef.get()).exists;
                if (exists) {
                    studentRegisterMessage.textContent = `ERROR: STUDENT WITH ID ${id} ALREADY EXISTS.`;
                    studentRegisterMessage.className = 'text-center mt-2 text-neon-red';
                    return;
                }
                let photoUrl = null;
                if (photoFile) {
                    const storageRef = storage.ref().child(`photos/students/${id}`);
                    await storageRef.put(photoFile);
                    photoUrl = await storageRef.getDownloadURL();
                }
                await studentRef.set({
                    name,
                    id,
                    hostel,
                    program,
                    year: Number(year),
                    photo: photoUrl || null,
                    stationHistory: []
                });
                studentRegisterForm.reset();
                studentRegisterMessage.textContent = `STUDENT ${name} REGISTERED SUCCESSFULLY!`;
                studentRegisterMessage.className = 'text-center mt-2 text-neon-green';
                logActivity(`ADMIN REGISTERED STUDENT ${name} (ID: ${id}).`);
            } catch (err) {
                console.error(err);
                studentRegisterMessage.textContent = err.message || 'FAILED TO REGISTER STUDENT.';
                studentRegisterMessage.className = 'text-center mt-2 text-neon-red';
            }
        });

        // ---------- Register supervisor (create Auth user + Firestore doc) ----------
        supervisorRegisterForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            supervisorRegisterMessage.textContent = '';
            const name = e.target['supervisor-name'].value.trim();
            const regId = e.target['supervisor-reg-id'].value.trim();
            const email = e.target['supervisor-email'].value.trim();
            const password = e.target['supervisor-reg-password'].value;
            const photoFile = document.getElementById('supervisor-photo').files[0];
            try {
                const supRef = db.collection('supervisors').doc(regId);
                const exists = (await supRef.get()).exists;
                if (exists) {
                    supervisorRegisterMessage.textContent = `ERROR: SUPERVISOR WITH ID ${regId} ALREADY EXISTS.`;
                    supervisorRegisterMessage.className = 'text-center mt-2 text-neon-red';
                    return;
                }
                // create auth user
                const userCred = await auth.createUserWithEmailAndPassword(email, password);
                const authUid = userCred.user.uid;
                let photoUrl = null;
                if (photoFile) {
                    const storageRef = storage.ref().child(`photos/supervisors/${regId}`);
                    await storageRef.put(photoFile);
                    photoUrl = await storageRef.getDownloadURL();
                }
                await supRef.set({
                    name,
                    id: regId,
                    email,
                    photo: photoUrl || null,
                    isBlocked: false,
                    authUid
                });
                supervisorRegisterForm.reset();
                supervisorPasswordStrength.textContent = '';
                supervisorRegisterMessage.textContent = `SUPERVISOR ${name} REGISTERED SUCCESSFULLY!`;
                supervisorRegisterMessage.className = 'text-center mt-2 text-neon-green';
                logActivity(`ADMIN REGISTERED NEW SUPERVISOR ${name} (ID: ${regId}).`);
            } catch (err) {
                console.error(err);
                supervisorRegisterMessage.textContent = err.message || 'FAILED TO REGISTER SUPERVISOR.';
                supervisorRegisterMessage.className = 'text-center mt-2 text-neon-red';
            }
        });

        // ---------- Render user list (students + supervisors) ----------
        userSearchInput.addEventListener('input', () => renderUserList());
        function renderUserList() {
            const query = '';
            userList.innerHTML = '';
            const allUsers = [
                ...studentsCache.map(u => ({...u, role: 'student'})), 
                ...supervisorsCache.map(u => ({...u, role: 'supervisor'}))
            ].sort((a,b) => a.name.localeCompare(b.name)); // Sort by name

            const filteredUsers = allUsers.filter(u =>
                u.name.toLowerCase().includes(query) || u.id.toLowerCase().includes(query)
            );
            
            if (filteredUsers.length === 0) {
                userList.innerHTML = '<p class="text-center text-neon-red">NO USERS FOUND.</p>';
                return;
            }

            filteredUsers.forEach(user => {
                const userCard = document.createElement('div');
                userCard.className = 'system-panel mt-2';
                userCard.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <img src="${user.photo || 'https://via.placeholder.com/64?text=NO+PHOTO'}" alt="User Photo" style="width: 64px; height: 64px; border-radius: 50%; object-fit: cover; border: 1px dashed #00ff00;">
                        <div>
                            <p class="text-xl text-neon-green">${user.name} <span class="text-sm text-neon-blue">(${user.role.toUpperCase()})</span></p>
                            <p>ID: ${user.id}</p>
                            ${user.role === 'supervisor' && user.isBlocked ? '<p class="text-neon-red">BLOCKED</p>' : ''}
                        </div>
                    </div>
                    <div style="display:flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1rem;">
                        <button class="btn-primary" onclick="showUserModal('${user.id}', '${user.role}')">VIEW/EDIT</button>
                        ${user.role === 'supervisor' ? `
                            ${user.isBlocked ? `<button class="btn-success" onclick="toggleSupervisorBlock('${user.id}', false)">UNBLOCK</button>` : `<button class="btn-warning" onclick="toggleSupervisorBlock('${user.id}', true)">BLOCK</button>`}
                        ` : ''}
                        <button class="btn-danger" onclick="deleteUser('${user.id}', '${user.role}')">DELETE</button>
                    </div>
                `;
                userList.appendChild(userCard);
            });
        }
        
        async function showUserModal(id, role) {
            userModalContent.innerHTML = '<p>LOADING...</p>';
            userModalTitle.textContent = 'USER DETAILS';
            document.getElementById('edit-user-form').dataset.userId = id;
            document.getElementById('edit-user-form').dataset.userRole = role;
            
            const user = role === 'student' ? studentsCache.find(s => s.id === id) : supervisorsCache.find(s => s.id === id);

            if (!user) {
                userModalContent.innerHTML = '<p class="text-neon-red">USER NOT FOUND.</p>';
                openModal('user-detail-modal');
                return;
            }

            let content = '';
            if (role === 'student') {
                content = `
                    <p class="text-neon-green">Name:</p><input type="text" name="name" value="${user.name}" required>
                    <p class="text-neon-green">Student ID:</p><input type="text" name="id" value="${user.id}" readonly>
                    <p class="text-neon-green">Hostel.Room:</p><input type="text" name="hostel" value="${user.hostel}" required>
                    <p class="text-neon-green">Program:</p><input type="text" name="program" value="${user.program}" required>
                    <p class="text-neon-green">Year:</p><input type="number" name="year" value="${user.year}" required>
                `;
            } else {
                content = `
                    <p class="text-neon-green">Name:</p><input type="text" name="name" value="${user.name}" required>
                    <p class="text-neon-green">ID:</p><input type="text" name="id" value="${user.id}" readonly>
                    <p class="text-neon-green">Email:</p><input type="email" name="email" value="${user.email}" required>
                    <p class="text-neon-green">Is Blocked:</p>
                    <select name="isBlocked">
                        <option value="false" ${!user.isBlocked ? 'selected' : ''}>No</option>
                        <option value="true" ${user.isBlocked ? 'selected' : ''}>Yes</option>
                    </select>
                `;
            }
            
            userModalContent.innerHTML = content;
            openModal('user-detail-modal');
        }

        async function saveUserChanges(e) {
            e.preventDefault();
            const form = e.target;
            const userId = form.dataset.userId;
            const userRole = form.dataset.userRole;
            const updates = {};
            for (let i = 0; i < form.elements.length; i++) {
                const el = form.elements[i];
                if (el.name && el.name !== 'id') {
                    if (el.type === 'number') {
                        updates[el.name] = Number(el.value);
                    } else if (el.name === 'isBlocked') {
                        updates[el.name] = el.value === 'true';
                    } else {
                        updates[el.name] = el.value;
                    }
                }
            }
            try {
                await db.collection(`${userRole}s`).doc(userId).update(updates);
                logActivity(`ADMIN UPDATED ${userRole.toUpperCase()} DETAILS FOR ${userId}.`);
                closeModal('user-detail-modal');
            } catch (error) {
                console.error("Error updating user: ", error);
                alert('FAILED TO UPDATE USER. ' + error.message);
            }
        }
        document.getElementById('edit-user-form').addEventListener('submit', saveUserChanges);

        async async function toggleSupervisorBlock(id, isBlocked) {
            if (confirm(`ARE YOU SURE YOU WANT TO ${isBlocked ? 'BLOCK' : 'UNBLOCK'} SUPERVISOR ${id}?`)) {
                try {
                    await db.collection('supervisors').doc(id).update({ isBlocked });
                    logActivity(`ADMIN ${isBlocked ? 'BLOCKED' : 'UNBLOCKED'} SUPERVISOR (ID: ${id}).`);
                } catch (error) {
                    console.error("Error toggling block status: ", error);
                    alert('FAILED TO UPDATE SUPERVISOR STATUS.');
                }
            }
        }
        async function deleteUser(id, role) {
            if (confirm(`ARE YOU SURE YOU WANT TO DELETE THIS ${role.toUpperCase()} (ID: ${id})? THIS ACTION CANNOT BE UNDONE.`)) {
                try {
                    // Check if student is assigned to a station
                    if (role === 'student') {
                         const stations = window._stationsCache.filter(s => s.assignedTo === id);
                         if (stations.length > 0) {
                             alert(`Cannot delete student ${id}. They are currently assigned to station(s) ${stations.map(s => s.id).join(', ')}. Please unassign them first.`);
                             return;
                         }
                    }

                    // For supervisor, delete auth user first
                    if (role === 'supervisor') {
                        const supDoc = await db.collection('supervisors').doc(id).get();
                        const supData = supDoc.data();
                        // This is a complex operation that requires a server-side function, but we can log the intent.
                        // In a real system, you would call a Firebase Cloud Function to delete the user from Auth.
                        logActivity(`ADMIN DELETED SUPERVISOR AUTH ACCOUNT. (Requires Cloud Function).`);
                    }
                    
                    await db.collection(`${role}s`).doc(id).delete();
                    // Also delete photo from storage
                    const photoRef = storage.ref().child(`photos/${role}s/${id}`);
                    try {
                        await photoRef.delete();
                    } catch (e) {
                        console.log("No photo to delete for user, or it doesn't exist.");
                    }

                    logActivity(`ADMIN DELETED ${role.toUpperCase()} (ID: ${id}).`);
                } catch (error) {
                    console.error("Error deleting user: ", error);
                    alert('FAILED TO DELETE USER. ' + error.message);
                }
            }
        }
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        // ---------- Report Generation ----------
        function updateReportCounts() {
            const occupied = window._stationsCache.filter(s => s.isOccupied).length;
            const unoccupied = window._stationsCache.filter(s => !s.isOccupied && !s.statusFlag).length;
            const students = studentsCache.length;
            const supervisors = supervisorsCache.length;
            document.getElementById('report-supervisors').textContent = supervisors;
            document.getElementById('report-students').textContent = students;
            document.getElementById('report-total-stations').textContent = window._stationsCache.length;
            document.getElementById('report-occupied-stations').textContent = occupied;
            document.getElementById('report-unoccupied-stations').textContent = unoccupied;
        }

        async function generateReport() {
            const reportData = {
                timestamp: new Date().toISOString(),
                totalSupervisors: supervisorsCache.length,
                totalStudents: studentsCache.length,
                totalStations: window._stationsCache.length,
                occupiedStations: window._stationsCache.filter(s => s.isOccupied).length,
                unoccupiedStations: window._stationsCache.filter(s => !s.isOccupied).length,
                stationsNeedingMaintenance: window._stationsCache.filter(s => s.statusFlag === 'Needs Maintenance').length,
                // Add more data as needed
            };
            const reportString = JSON.stringify(reportData, null, 2);
            alert('REPORT GENERATED:\n' + reportString);
            logActivity('Admin generated a system report.');
        }

        customReportForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const start = e.target['report-start-date'].value;
            const end = e.target['report-end-date'].value;
            const metrics = Array.from(e.target.querySelectorAll('input[name="metric"]:checked')).map(el => el.value);

            if (!start || !end || metrics.length === 0) {
                alert('Please select a date range and at least one metric.');
                return;
            }

            const startDate = new Date(start).getTime();
            const endDate = new Date(end).getTime() + 86400000; // end of the day

            const allLogsSnapshot = await db.collection('activities')
                .where('time', '>=', startDate)
                .where('time', '<=', endDate)
                .get();

            const allLogs = allLogsSnapshot.docs.map(doc => doc.data());

            let reportText = `CUSTOM REPORT FROM ${start} TO ${end}\n\n`;
            reportText += `Number of activities logged: ${allLogs.length}\n\n`;

            if (metrics.includes('mostUsed') || metrics.includes('leastUsed')) {
                const stationUsage = {};
                allLogs.filter(l => l.message.includes('ASSIGNED'))
                    .forEach(log => {
                        const stationId = log.message.match(/station (\d+)/i);
                        if (stationId) {
                            const id = stationId[1];
                            stationUsage[id] = (stationUsage[id] || 0) + 1;
                        }
                    });

                const sortedStations = Object.entries(stationUsage).sort(([, a], [, b]) => b - a);

                if (metrics.includes('mostUsed')) {
                    reportText += '--- MOST USED STATIONS ---\n';
                    sortedStations.slice(0, 5).forEach(([id, count]) => {
                        reportText += `Station ${id}: ${count} assignments\n`;
                    });
                    reportText += '\n';
                }

                if (metrics.includes('leastUsed')) {
                    reportText += '--- LEAST USED STATIONS ---\n';
                    sortedStations.slice(-5).forEach(([id, count]) => {
                        reportText += `Station ${id}: ${count} assignments\n`;
                    });
                    reportText += '\n';
                }
            }

            if (metrics.includes('averageSession')) {
                 const sessionDurations = allLogs.filter(l => l.message.includes('UNASSIGNED'))
                     .map(log => {
                         const durationMatch = log.message.match(/session duration: (\d+) minutes/i);
                         return durationMatch ? Number(durationMatch[1]) : 0;
                     }).filter(d => d > 0);

                 const totalDuration = sessionDurations.reduce((sum, d) => sum + d, 0);
                 const averageDuration = sessionDurations.length > 0 ? (totalDuration / sessionDurations.length).toFixed(2) : 0;
                 reportText += `--- AVERAGE SESSION TIME ---\n`;
                 reportText += `Average session duration: ${averageDuration} minutes\n\n`;
            }
            
            customReportOutput.innerHTML = `<pre>${reportText}</pre>`;
            customReportOutput.style.display = 'block';
            logActivity('Admin generated a custom report.');
        });

        // ---------- Render station status for admin dashboard ----------
        function renderStationStatusAdmin() {
            const stations = window._stationsCache || [];
            stationStatusAdmin.innerHTML = '';
            stations.forEach(station => {
                const statusClass = station.isOccupied ? 'occupied' : (station.statusFlag === 'Needs Maintenance' ? 'needs-maintenance' : 'unoccupied');
                const user = studentsCache.find(s => s.id === station.assignedTo);
                const userText = user ? `${user.name} (${user.id})` : '';
                const supervisor = supervisorsCache.find(s => s.id === station.assignedBy);
                const supervisorText = supervisor ? `${supervisor.name} (${supervisor.id})` : '';

                const stationCard = document.createElement('div');
                stationCard.className = `station-card ${statusClass}`;
                stationCard.innerHTML = `
                    <h3>STATION ${station.id}</h3>
                    <p>STATUS: ${station.isOccupied ? 'OCCUPIED' : (station.statusFlag ? station.statusFlag.toUpperCase() : 'AVAILABLE')}</p>
                    ${station.isOccupied ? `
                        <p class="text-neon-red">ASSIGNED TO: ${userText}</p>
                        <p class="text-neon-blue">ASSIGNED BY: ${supervisorText}</p>
                    ` : ''}
                    ${station.isOccupied && station.sessionEndTime ? `<p class="text-neon-blue">SESSION ENDS: ${new Date(station.sessionEndTime).toLocaleTimeString()}</p>` : ''}
                    ${station.statusFlag ? `<p class="text-neon-yellow">ISSUE: ${station.statusFlag}</p>` : ''}
                `;
                stationStatusAdmin.appendChild(stationCard);
            });
        }

        // ---------- Render station status for supervisor dashboard ----------
        function renderStationStatusSupervisor() {
            const stations = window._stationsCache || [];
            stationStatusSupervisor.innerHTML = '';
            stations.forEach(station => {
                const statusClass = station.isOccupied ? 'occupied' : (station.statusFlag === 'Needs Maintenance' ? 'needs-maintenance' : 'unoccupied');
                const user = studentsCache.find(s => s.id === station.assignedTo);
                const userText = user ? `${user.name} (${user.id})` : '';
                const supervisor = supervisorsCache.find(s => s.id === station.assignedBy);
                const supervisorText = supervisor ? `${supervisor.name} (${supervisor.id})` : '';
                const stationCard = document.createElement('div');
                stationCard.className = `station-card ${statusClass}`;
                stationCard.innerHTML = `
                    <h3>STATION ${station.id}</h3>
                    <p>STATUS: ${station.isOccupied ? 'OCCUPIED' : (station.statusFlag ? station.statusFlag.toUpperCase() : 'AVAILABLE')}</p>
                    ${station.isOccupied ? `
                        <p class="text-neon-red">ASSIGNED TO: ${userText}</p>
                        <p class="text-neon-blue">ASSIGNED BY: ${supervisorText}</p>
                    ` : ''}
                    ${station.isOccupied && station.sessionEndTime ? `<p class="text-neon-blue">SESSION ENDS: ${new Date(station.sessionEndTime).toLocaleTimeString()}</p>` : ''}
                    ${station.statusFlag ? `<p class="text-neon-yellow">ISSUE: ${station.statusFlag}</p>` : ''}
                    <div class="supervisor-actions">
                        ${station.isOccupied ? `<button class="btn-danger" onclick="unassignStation(${station.id})">UNASSIGN</button>` : ''}
                        <button class="btn-primary" onclick="showAssignStationForm(${station.id})">ASSIGN</button>
                    </div>
                `;
                stationStatusSupervisor.appendChild(stationCard);
            });
        }
        
        function showAssignStationForm(stationId) {
            stationSelect.value = stationId;
            // Scroll to the assignment form
            stationAssignmentForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        async function unassignStation(stationId) {
            if (confirm(`Are you sure you want to unassign station ${stationId}?`)) {
                try {
                    const stationRef = db.collection('stations').doc(String(stationId));
                    const stationDoc = await stationRef.get();
                    const stationData = stationDoc.data();
                    
                    const sessionDuration = Math.ceil((Date.now() - new Date(stationData.sessionStartTime).getTime()) / (1000 * 60));

                    await stationRef.update({
                        isOccupied: false,
                        assignedTo: null,
                        assignedBy: null,
                        sessionEndTime: null,
                        sessionDuration: null,
                        sessionStartTime: null
                    });
                    
                    // Add to activity log
                    logActivity(`Supervisor UNASSIGNED student (ID: ${stationData.assignedTo}) from station ${stationId}. Final session duration: ${sessionDuration} minutes.`);
                    
                } catch (error) {
                    console.error("Error unassigning station: ", error);
                    alert('Failed to unassign station.');
                }
            }
        }

        // ---------- Kiosk view rendering ----------
        function renderKioskStations() {
            const stations = window._stationsCache || [];
            kioskStationList.innerHTML = '';
            stations.forEach(station => {
                const statusClass = station.isOccupied ? 'occupied' : (station.statusFlag === 'Needs Maintenance' ? 'needs-maintenance' : 'unoccupied');
                const stationCard = document.createElement('div');
                stationCard.className = `kiosk-card ${statusClass}`;
                stationCard.innerHTML = `
                    <h3>STATION ${station.id}</h3>
                    <p>STATUS: ${station.isOccupied ? 'OCCUPIED' : (station.statusFlag ? station.statusFlag.toUpperCase() : 'AVAILABLE')}</p>
                `;
                kioskStationList.appendChild(stationCard);
            });
        }

        // ---------- Station management (selectors and assignment) ----------
        function renderStationSelectors() {
            const stations = window._stationsCache || [];
            stationSelect.innerHTML = '<option value="">SELECT A STATION</option>';
            issueStationSelect.innerHTML = '<option value="">SELECT STATION</option>';
            stations.forEach(station => {
                // For assignment, only show available stations
                if (!station.isOccupied && !station.statusFlag) {
                    const option = document.createElement('option');
                    option.value = station.id;
                    option.textContent = `STATION ${station.id}`;
                    stationSelect.appendChild(option);
                }
                // For issue reporting, show all stations
                const option = document.createElement('option');
                option.value = station.id;
                option.textContent = `STATION ${station.id}`;
                issueStationSelect.appendChild(option);
            });
        }

        let studentLookupDebounce;
        studentLookupInput.addEventListener('input', () => {
            clearTimeout(studentLookupDebounce);
            studentLookupDebounce = setTimeout(async () => {
                const query = studentLookupInput.value.trim();
                studentProfilePreview.style.display = 'none';
                studentLookupMessage.textContent = '';
                if (query.length < 3) return;

                const student = studentsCache.find(s => s.id.toLowerCase().includes(query.toLowerCase()) || s.name.toLowerCase().includes(query.toLowerCase()));
                
                if (student) {
                    // Check if student is already assigned
                    const isAlreadyAssigned = window._stationsCache.some(s => s.assignedTo === student.id);
                    if (isAlreadyAssigned) {
                        studentLookupMessage.textContent = 'STUDENT IS ALREADY ASSIGNED TO A STATION.';
                        studentLookupMessage.className = 'text-center mt-2 text-neon-red';
                        return;
                    }

                    studentPhotoPreview.src = student.photo || 'https://via.placeholder.com/64?text=NO+PHOTO';
                    studentDetailsPreview.innerHTML = `
                        <p>NAME: ${student.name}</p>
                        <p>ID: ${student.id}</p>
                        <p>PROGRAM: ${student.program}</p>
                    `;
                    studentProfilePreview.style.display = 'flex';
                } else {
                    studentLookupMessage.textContent = 'STUDENT NOT FOUND.';
                    studentLookupMessage.className = 'text-center mt-2 text-neon-red';
                }
            }, 500);
        });

        stationAssignmentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            studentLookupMessage.textContent = '';
            const stationId = e.target['station-select'].value;
            const studentQuery = e.target['student-lookup-input'].value.trim();
            const duration = e.target['session-duration'].value;
            
            if (!stationId || !studentQuery || !duration) {
                studentLookupMessage.textContent = 'PLEASE FILL IN ALL FIELDS.';
                studentLookupMessage.className = 'text-center mt-2 text-neon-red';
                return;
            }

            const student = studentsCache.find(s => s.id.toLowerCase().includes(studentQuery.toLowerCase()) || s.name.toLowerCase().includes(studentQuery.toLowerCase()));

            if (!student) {
                studentLookupMessage.textContent = 'STUDENT NOT FOUND.';
                studentLookupMessage.className = 'text-center mt-2 text-neon-red';
                return;
            }

            // Check if student is already assigned
            const isAlreadyAssigned = window._stationsCache.some(s => s.assignedTo === student.id);
            if (isAlreadyAssigned) {
                studentLookupMessage.textContent = 'STUDENT IS ALREADY ASSIGNED TO A STATION.';
                studentLookupMessage.className = 'text-center mt-2 text-neon-red';
                return;
            }
            
            const stationRef = db.collection('stations').doc(stationId);
            const stationDoc = await stationRef.get();
            if (!stationDoc.exists || stationDoc.data().isOccupied) {
                studentLookupMessage.textContent = 'STATION IS ALREADY OCCUPIED OR DOES NOT EXIST.';
                studentLookupMessage.className = 'text-center mt-2 text-neon-red';
                return;
            }

            try {
                const sessionStartTime = Date.now();
                const sessionEndTime = sessionStartTime + (duration * 60 * 1000);
                await stationRef.update({
                    isOccupied: true,
                    assignedTo: student.id,
                    assignedBy: currentUser.id,
                    sessionStartTime,
                    sessionEndTime,
                    sessionDuration: Number(duration)
                });
                
                db.collection('meta').doc('lastAssignment').set({ stationId: stationId, studentId: student.id, studentName: student.name, supervisorId: currentUser.id, supervisorName: currentUser.name, time: Date.now() });
                
                // Add to student history
                const studentRef = db.collection('students').doc(student.id);
                const studentDoc = await studentRef.get();
                const history = studentDoc.data().stationHistory || [];
                history.push({
                    stationId: stationId,
                    assignedAt: sessionStartTime,
                    duration: Number(duration)
                });
                await studentRef.update({ stationHistory: history });

                stationAssignmentForm.reset();
                studentProfilePreview.style.display = 'none';
                studentLookupMessage.textContent = `STATION ${stationId} ASSIGNED TO ${student.name} FOR ${duration} MINUTES.`;
                studentLookupMessage.className = 'text-center mt-2 text-neon-green';
                logActivity(`Supervisor ${currentUser.name} ASSIGNED student ${student.name} (ID: ${student.id}) to station ${stationId} for ${duration} minutes.`);
            } catch (err) {
                console.error(err);
                studentLookupMessage.textContent = err.message || 'FAILED TO ASSIGN STATION.';
                studentLookupMessage.className = 'text-center mt-2 text-neon-red';
            }
        });

        // ---------- Issue Reporting ----------
        issueReportForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const stationId = e.target['issue-station-select'].value;
            const issueType = e.target['issue-type'].value;
            const issueDescription = e.target['issue-description'].value;

            if (!stationId || !issueType) {
                alert('Please select a station and an issue type.');
                return;
            }

            try {
                await db.collection('stations').doc(stationId).update({ statusFlag: issueType, issue: issueDescription, issueReportedAt: Date.now() });
                issueReportForm.reset();
                alert('ISSUE REPORTED SUCCESSFULLY. ADMIN HAS BEEN NOTIFIED.');
                logActivity(`Supervisor ${currentUser.name} REPORTED an issue for station ${stationId}: ${issueType} - ${issueDescription}.`);
            } catch (err) {
                console.error(err);
                alert('FAILED TO REPORT ISSUE.');
            }
        });

        // ---------- Chat system ----------
        function renderChat(chatBox, userType) {
            const messages = window._chatsCache || [];
            chatBox.innerHTML = '';
            let unreadCount = 0;
            messages.forEach(msg => {
                const messageCard = document.createElement('div');
                const isMyMessage = (userType === 'admin' && msg.from === 'admin') || (userType === 'supervisor' && msg.from === 'supervisor');
                messageCard.className = `chat-message ${isMyMessage ? userType : (userType === 'admin' ? 'supervisor' : 'admin')}`;
                
                let senderName = 'UNKNOWN USER';
                if (msg.from === 'admin') {
                    senderName = 'ADMIN';
                } else if (msg.from === 'supervisor' && msg.supervisorId) {
                    const supervisor = supervisorsCache.find(s => s.id === msg.supervisorId);
                    if (supervisor) {
                        senderName = supervisor.name;
                    }
                }
                
                messageCard.innerHTML = `
                    <p class="text-sm font-bold">${senderName}</p>
                    <p>${msg.message}</p>
                    <p class="text-xs text-right">${new Date(msg.time).toLocaleTimeString()}</p>
                `;
                chatBox.appendChild(messageCard);
                // Auto-scroll to the bottom
                chatBox.scrollTop = chatBox.scrollHeight;
            });

            // Update notifications
            if (userType === 'admin') {
                const unread = messages.filter(m => m.from === 'supervisor' && !m.readByAdmin).length;
                if (unread > 0) {
                    adminChatNotification.style.display = 'inline-block';
                } else {
                    adminChatNotification.style.display = 'none';
                }
            } else { // supervisor
                const unread = messages.filter(m => m.from === 'admin' && !m.readBySupervisor).length;
                if (unread > 0) {
                    supervisorChatNotification.style.display = 'inline-block';
                } else {
                    supervisorChatNotification.style.display = 'none';
                }
            }
        }

        adminChatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const message = e.target['admin-chat-input'].value.trim();
            if (!message) return;
            try {
                await db.collection('chats').add({
                    from: 'admin',
                    message,
                    time: Date.now(),
                    readByAdmin: true,
                    readBySupervisor: false
                });
                e.target.reset();
            } catch (err) {
                console.error('Failed to send chat message:', err);
            }
        });

        supervisorChatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const message = e.target['supervisor-chat-input'].value.trim();
            if (!message || !currentUser) return;
            try {
                await db.collection('chats').add({
                    from: 'supervisor',
                    message,
                    time: Date.now(),
                    supervisorId: currentUser.id,
                    readByAdmin: false,
                    readBySupervisor: true
                });
                e.target.reset();
            } catch (err) {
                console.error('Failed to send chat message:', err);
            }
        });

        // Mark messages as read when the chat box is focused
        adminChatBox.addEventListener('focusin', async () => {
            // Find all unread messages from supervisors and mark them as read
            const unreadMessages = window._chatsCache.filter(m => m.from === 'supervisor' && !m.readByAdmin);
            const batch = db.batch();
            unreadMessages.forEach(msg => {
                const docRef = db.collection('chats').doc(msg.id);
                batch.update(docRef, { readByAdmin: true });
            });
            await batch.commit();
        });
        supervisorChatBox.addEventListener('focusin', async () => {
            const unreadMessages = window._chatsCache.filter(m => m.from === 'admin' && !m.readBySupervisor);
            const batch = db.batch();
            unreadMessages.forEach(msg => {
                const docRef = db.collection('chats').doc(msg.id);
                batch.update(docRef, { readBySupervisor: true });
            });
            await batch.commit();
        });


        // ---------- Admin Broadcast ----------
        broadcastForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const message = e.target['broadcast-message-input'].value.trim();
            if (!message) return;
            try {
                await db.collection('meta').doc('broadcast').set({ message, time: Date.now() });
                broadcastForm.reset();
                alert('BROADCAST SENT SUCCESSFULLY!');
                logActivity('Admin sent a system broadcast.');
            } catch (err) {
                console.error('Failed to send broadcast:', err);
                alert('FAILED TO SEND BROADCAST.');
            }
        });

        function dismissBroadcast() {
            broadcastMessageEl.style.display = 'none';
        }


        // ---------- Password Management ----------
        forgotPasswordBtn.addEventListener('click', () => {
            openModal('password-reset-modal');
        });
        cancelResetBtn.addEventListener('click', () => {
            closeModal('password-reset-modal');
        });
        supervisorChangePasswordBtn.addEventListener('click', () => {
            openModal('password-change-modal');
        });
        cancelChangeBtn.addEventListener('click', () => {
            closeModal('password-change-modal');
        });

        passwordResetForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            document.getElementById('reset-message').textContent = '';
            const name = e.target['reset-name'].value.trim();
            const id = e.target['reset-id'].value.trim();
            const oldPassword = e.target['reset-old-password'].value;
            const newPassword = e.target['reset-new-password'].value;

            try {
                // Find the supervisor document
                const supDoc = await db.collection('supervisors').doc(id).get();
                if (!supDoc.exists || supDoc.data().name !== name) {
                    document.getElementById('reset-message').textContent = 'INVALID CREDENTIALS.';
                    return;
                }
                const sup = supDoc.data();

                // Re-authenticate with old password
                const user = await auth.signInWithEmailAndPassword(sup.email, oldPassword);

                // Change password
                await user.user.updatePassword(newPassword);
                
                document.getElementById('reset-message').textContent = 'PASSWORD RESET SUCCESSFUL!';
                document.getElementById('reset-message').className = 'text-center mt-2 text-neon-green';
                logActivity(`Supervisor ${name} (ID: ${id}) reset their password.`);
                
            } catch (err) {
                console.error(err);
                document.getElementById('reset-message').textContent = err.message || 'PASSWORD RESET FAILED.';
                document.getElementById('reset-message').className = 'text-center mt-2 text-neon-red';
            }
        });

        passwordChangeForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            document.getElementById('change-password-message').textContent = '';
            const currentPassword = e.target['current-password'].value;
            const newPassword = e.target['new-password'].value;
            
            try {
                 // Re-authenticate the user with their current password
                 const credential = firebase.auth.EmailAuthProvider.credential(
                    auth.currentUser.email,
                    currentPassword
                 );
                 await auth.currentUser.reauthenticateWithCredential(credential);
                 // If re-authentication is successful, update the password
                 await auth.currentUser.updatePassword(newPassword);
                 
                 document.getElementById('change-password-message').textContent = 'PASSWORD CHANGED SUCCESSFULLY!';
                 document.getElementById('change-password-message').className = 'text-center mt-2 text-neon-green';
                 logActivity(`Supervisor ${currentUser.name} (ID: ${currentUser.id}) changed their password.`);
                 
            } catch (err) {
                console.error(err);
                document.getElementById('change-password-message').textContent = err.message || 'PASSWORD CHANGE FAILED.';
                document.getElementById('change-password-message').className = 'text-center mt-2 text-neon-red';
            }
        });
        
        // Live password strength checker
        function checkPasswordStrength(password, strengthIndicator) {
            let strength = 0;
            if (password.length > 5) strength++;
            if (password.match(/[a-z]/)) strength++;
            if (password.match(/[A-Z]/)) strength++;
            if (password.match(/[0-9]/)) strength++;
            if (password.match(/[^a-zA-Z0-9]/)) strength++;

            if (password.length > 0) {
                if (strength <= 2) {
                    strengthIndicator.textContent = 'WEAK';
                    strengthIndicator.className = 'password-strength weak';
                } else if (strength <= 4) {
                    strengthIndicator.textContent = 'MEDIUM';
                    strengthIndicator.className = 'password-strength medium';
                } else {
                    strengthIndicator.textContent = 'STRONG';
                    strengthIndicator.className = 'password-strength strong';
                }
            } else {
                strengthIndicator.textContent = '';
                strengthIndicator.className = 'password-strength';
            }
        }
        supervisorRegPasswordInput.addEventListener('input', (e) => checkPasswordStrength(e.target.value, supervisorPasswordStrength));
        newPasswordInput.addEventListener('input', (e) => checkPasswordStrength(e.target.value, newPasswordStrength));
        
        // ---------- Activity Logging ----------
        function logActivity(message) {
            db.collection('activities').add({
                message,
                time: Date.now(),
                user: currentUser ? currentUser.name : 'System',
                role: currentUser ? currentUser.role : 'System'
            }).catch(err => console.error("Error logging activity:", err));
        }

        // ---------- Supervisor Profile Photo ----------
        async function renderSupervisorProfile() {
            if (currentUser && currentUser.role === 'supervisor') {
                const supDoc = await db.collection('supervisors').doc(currentUser.id).get();
                const sup = supDoc.data();
                if (sup && sup.photo) {
                    supervisorProfilePhoto.innerHTML = `<img src="${sup.photo}" alt="Profile Photo" style="width: 100%; height: 100%; object-fit: cover;">`;
                } else {
                    supervisorProfilePhoto.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#00ff00" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>`;
                }
            }
        }

        // ---------- Session Timeout Logic & Kiosk update----------
        setInterval(() => {
            if (currentUser && currentUser.role === 'supervisor') {
                const occupiedStations = window._stationsCache.filter(s => s.isOccupied);
                occupiedStations.forEach(async (station) => {
                    if (Date.now() > station.sessionEndTime) {
                         const sessionDuration = Math.ceil((station.sessionEndTime - station.sessionStartTime) / (1000 * 60));
                         await db.collection('stations').doc(String(station.id)).update({
                            isOccupied: false,
                            assignedTo: null,
                            assignedBy: null,
                            sessionEndTime: null,
                            sessionDuration: null,
                            sessionStartTime: null
                         });
                         // Add to activity log for auto-unassignment
                         logActivity(`System AUTO-UNASSIGNED student (ID: ${station.assignedTo}) from station ${station.id} after session timeout of ${sessionDuration} minutes.`);
                    }
                });
            }
        }, 60000); // Check every minute
        
        // Init
        updateWelcomeMessage();
        setInterval(updateWelcomeMessage, 1000);
        
        auth.onAuthStateChanged(user => {
            if (user) {
                // User is signed in. Do nothing for now, the screen will be handled by the login forms.
            } else {
                currentUser = null;
                showScreen('login-screen');
                ensureAdminSettings();
                ensureStationsExist();
            }
        });
    </script>
</body>
</html>