


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin & Supervisor System (Firebase Enabled)</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Firebase (compat) SDKs for easier migration -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
    <style>
        /* Light mode support */
        .light-mode body, .light-mode {
            background: #f7f7f7;
            color: #111;
        }
        .light-mode .system-panel {
            background: #ffffff;
            border-color: #222;
        }
        .light-mode .btn-primary { background: #0077ff; color: #fff; border-color:#005bbb; }
        .light-mode .btn-success { background: #28a745; color:#fff; }
        .light-mode .btn-warning { background: #ffc107; color:#000; }
        .light-mode .btn-danger  { background: #dc3545; color:#fff; }
        .light-mode input, .light-mode select, .light-mode textarea {
            background:#fff; color:#000; border-color:#333;
        }
        .light-mode .text-neon-blue, .light-mode .text-neon-green, .light-mode .text-neon-yellow, .light-mode .text-neon-red {
            color: #111 !important;
        }
        .light-mode .station-card.occupied {
            border-color:#ff3333; background-color:#ffe5e5;
        }
        .light-mode .station-card.unoccupied {
            border-color:#00cc00; background-color:#e6ffe6;
        }
        .light-mode .station-card.needs-maintenance {
            border-color:#cccc00; background-color:#ffffe6;
        }

        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap');
        body {
            font-family: 'Roboto Mono', monospace;
            background-color: #1a1a1a;
            color: #00ff00;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 2rem;
            box-sizing: border-box;
        }
        .container {
            width: 100%;
            max-width: 1200px;
        }
        .system-panel {
            background-color: #000000;
            border: 2px solid #00ff00;
            box-shadow: 0 0 10px #00ff00;
            padding: 2rem;
            margin-bottom: 2rem;
            animation: terminalGlow 2s infinite alternate;
        }
        @keyframes terminalGlow {
            from { box-shadow: 0 0 5px #00ff00; }
            to { box-shadow: 0 0 15px #00ff00; }
        }
        .login-card {
            max-width: 500px;
            margin: 0 auto;
        }
        input, select, textarea {
            background-color: #0d0d0d;
            border: 1px solid #00ff00;
            color: #00ff00;
            padding: 0.75rem;
            width: 100%;
            margin-top: 0.5rem;
            margin-bottom: 1rem;
            box-shadow: inset 0 0 5px #00ff0080;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            box-shadow: 0 0 10px #00ff00;
        }
        button {
            background-color: #00aaff;
            color: #000000;
            font-weight: bold;
            padding: 0.75rem 1.5rem;
            border: 2px solid #00aaff;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        button.btn-primary { background-color: #00aaff; border-color: #00aaff; }
        button.btn-danger { background-color: #ff3333; border-color: #ff3333; }
        button.btn-warning { background-color: #ffff33; border-color: #ffff33; color: #000; }
        button.btn-success { background-color: #00cc00; border-color: #00cc00; }
        button:hover {
            filter: brightness(1.2);
            box-shadow: 0 0 10px;
        }
        .text-neon-blue { color: #00aaff; }
        .text-neon-green { color: #00ff00; }
        .text-neon-red { color: #ff3333; }
        .text-neon-yellow { color: #ffff33; }
        .flex-container {
            display: flex;
            gap: 2rem;
            flex-wrap: wrap;
        }
        .flex-container > div {
            flex: 1;
            min-width: 400px;
        }
        .grid-container {
            display: grid;
            gap: 1rem;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        }
        .station-card {
            border: 1px dashed #00ff00;
            padding: 1rem;
            text-align: center;
        }
        .station-card.occupied {
            border-color: #ff3333;
            background-color: rgba(255, 51, 51, 0.1);
        }
        .station-card.unoccupied {
            border-color: #00cc00;
            background-color: rgba(0, 204, 0, 0.1);
        }
        .station-card.needs-maintenance {
            border-color: #ffff33;
            background-color: rgba(255, 255, 51, 0.1);
        }
        .chat-container {
            height: 300px;
            overflow-y: auto;
            border: 1px solid #00ff00;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .chat-message {
            max-width: 75%;
            padding: 0.5rem;
            border: 1px solid;
        }
        .chat-message.admin {
            align-self: flex-end;
            background-color: rgba(0, 170, 255, 0.2);
            border-color: #00aaff;
        }
        .chat-message.supervisor {
            align-self: flex-start;
            background-color: rgba(0, 204, 0, 0.2);
            border-color: #00cc00;
        }
        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #000;
            border: 2px solid #00ff00;
            box-shadow: 0 0 10px #00ff00;
            padding: 2rem;
            z-index: 1000;
            color: #00ff00;
            display: none;
        }
        .broadcast-message {
            position: fixed;
            top: 1rem;
            left: 50%;
            transform: translateX(-50%);
            background: #ff3333;
            color: #000;
            font-weight: bold;
            padding: 1rem 2rem;
            border: 2px solid #000;
            box-shadow: 0 0 15px #ff3333;
            z-index: 2000;
            display: none;
            animation: pulseGlow 1s infinite alternate;
        }
        @keyframes pulseGlow {
            from { box-shadow: 0 0 5px #ff3333; }
            to { box-shadow: 0 0 20px #ff3333; }
        }
        .report-section {
            background-color: #0d0d0d;
            padding: 1rem;
            border: 1px solid #00ff00;
            margin-top: 1rem;
        }
        .password-strength {
            font-size: 0.8rem;
            margin-top: -0.5rem;
            margin-bottom: 0.5rem;
            text-align: left;
        }
        .password-strength.weak { color: #ff3333; }
        .password-strength.medium { color: #ffff33; }
        .password-strength.strong { color: #00cc00; }
        .blinking-dot {
            height: 10px;
            width: 10px;
            background-color: #ff3333;
            border-radius: 50%;
            display: inline-block;
            margin-left: 5px;
            animation: blink 1s linear infinite;
        }
        @keyframes blink {
            50% { opacity: 0; }
        }
        .kiosk-card {
            background-color: #000000;
            border: 1px solid #00ff00;
            padding: 1rem;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="broadcast-message" class="broadcast-message">
            <p id="broadcast-text"></p>
            <button onclick="dismissBroadcast()" style="background: #000; color: #ff3333; border-color: #ff3333;">DISMISS</button>
        </div>

        <div id="login-screen" class="system-panel login-card">
            <h1 class="text-neon-green text-3xl font-bold mb-4 text-center">ACCESS TERMINAL</h1>
            <p id="welcome-message" class="text-center text-neon-green mb-4"></p>
            <div class="flex flex-col items-center mb-6">
                 <div class="p-4 rounded-full mb-2 border-2 border-dashed border-neon-green">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#00ff00" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-terminal-square"><path d="m7 11 2 2 4-4"/><rect width="18" height="18" x="3" y="3" rx="2"/></svg>
                </div>
            </div>
            <div class="flex justify-center mb-8">
                <button id="show-admin-login-btn" class="btn-primary w-1/3">ADMIN</button>
                <button id="show-supervisor-login-btn" class="btn-success w-1/3">SUPERVISOR</button>
                <button id="show-kiosk-btn" class="btn-warning w-1/3">KIOSK</button>
            </div>
            <form id="admin-login-form">
                <h2 class="text-neon-blue text-center mb-4">ADMIN LOGIN</h2>
                <input type="text" id="admin-username" placeholder="Username" required>
                <input type="password" id="admin-password" placeholder="Password" required>
                <input type="password" id="admin-secret-code" placeholder="Secret Code" required>
                <button type="submit" class="btn-primary w-full">LOG IN</button>
                <p id="admin-login-message" class="text-center text-neon-red mt-2"></p>
            </form>
            <form id="supervisor-login-form" style="display:none;">
                <h2 class="text-neon-green text-center mb-4">SUPERVISOR LOGIN</h2>
                <input type="text" id="supervisor-id" placeholder="ID" required>
                <input type="password" id="supervisor-password" placeholder="Password" required>
                <button type="submit" class="btn-success w-full">LOG IN</button>
                <button type="button" id="forgot-password-btn" class="btn-warning w-full mt-2">FORGOT PASSWORD?</button>
                <p id="supervisor-login-message" class="text-center text-neon-red mt-2"></p>
            </form>
        </div>
        <div id="admin-dashboard" style="display:none;">
            
<div class="flex-container mt-2" id="admin-quick-nav">
    <div style="display:flex; gap:0.5rem; flex-wrap:wrap;">
        <button class="btn-primary" onclick="scrollToSection('admin-register-student')">Register Student</button>
        <button class="btn-primary" onclick="scrollToSection('admin-register-supervisor')">Register Supervisor</button>
        <button class="btn-primary" onclick="scrollToSection('admin-user-management')">User Management</button>
        <button class="btn-primary" onclick="scrollToSection('admin-activities')">Activities & Reports</button>
        <button class="btn-primary" onclick="scrollToSection('admin-station-status')">Station Status</button>
        <button class="btn-primary" onclick="scrollToSection('admin-chat')">Chat</button>
        <button class="btn-warning" onclick="toggleTheme()">Toggle Theme</button>
    </div>
    <div id="supervisor-on-duty" style="margin-left:auto; font-size:0.9rem;">
        <span class="text-neon-yellow">SUPERVISOR ON DUTY:</span>
        <span id="supervisor-on-duty-details" class="text-neon-green">None</span>
    </div>
</div>
<div class="system-panel">
                <div class="flex-container">
                    <h1 class="text-neon-blue text-3xl font-bold">ADMIN DASHBOARD</h1>
                    <button id="admin-logout-btn" class="btn-danger">LOGOUT</button>
                </div>
                <div class="flex-container mt-4">
                    <div class="system-panel">
                        <h2 id="admin-register-student" class="text-neon-blue text-2xl font-bold mb-4">REGISTER STUDENT</h2>
                        <form id="student-register-form">
                            <input type="text" id="student-name" placeholder="Student Name" required>
                            <input type="text" id="student-id" placeholder="Student ID" required>
                            <input type="text" id="student-hostel" placeholder="Hostel.Room" required>
                            <input type="text" id="student-program" placeholder="Program of Study" required>
                            <input type="number" id="student-year" placeholder="Year of Study" required>
                            <label class="text-neon-green">PHOTO UPLOAD</label>
                            <input type="file" id="student-photo">
                            <button type="submit" class="btn-primary w-full mt-4">REGISTER</button>
                            <p id="student-register-message" class="text-center mt-2"></p>
                        </form>
                    </div>
                    <div class="system-panel">
                        <h2 id="admin-register-supervisor" class="text-neon-blue text-2xl font-bold mb-4">REGISTER SUPERVISOR</h2>
                        <form id="supervisor-register-form">
                            <input type="text" id="supervisor-name" placeholder="Supervisor Name" required>
                            <input type="text" id="supervisor-reg-id" placeholder="ID" required>
                            <input type="email" id="supervisor-email" placeholder="Email" required>
                            <input type="password" id="supervisor-reg-password" placeholder="Password" required>
                            <div id="supervisor-password-strength" class="password-strength"></div>
                            <label class="text-neon-green">PHOTO UPLOAD</label>
                            <input type="file" id="supervisor-photo">
                            <button type="submit" class="btn-primary w-full mt-4">REGISTER</button>
                            <p id="supervisor-register-message" class="text-center mt-2"></p>
                        </form>
                    </div>
                </div>
                <div class="system-panel mt-4">
                    <h2 id="admin-user-management" class="text-neon-blue text-2xl font-bold mb-4">USER MANAGEMENT</h2>
                    <!-- Search removed by request --><input type="hidden" id="user-search-input" value="">
                    <div id="user-list"></div>
                </div>
                <div class="system-panel mt-4">
                    <h2 id="admin-activities" class="text-neon-blue text-2xl font-bold mb-4">SYSTEM ACTIVITIES & REPORTS</h2>
                    <div class="flex-container">
                        <div class="system-panel">
                            <h3 class="text-xl text-neon-green">ACTIVITY LOG</h3>
                            <ul id="activity-log" style="height: 150px; overflow-y: auto;"></ul>
                        </div>
                        <div class="system-panel">
                            <h3 class="text-xl text-neon-green">REPORT SUMMARY</h3>
                            <p>TOTAL SUPERVISORS: <span id="report-supervisors">0</span></p>
                            <p>TOTAL STUDENTS: <span id="report-students">0</span></p>
                            <p>TOTAL STATIONS: <span id="report-total-stations">0</span></p>
                            <p>OCCUPIED STATIONS: <span id="report-occupied-stations">0</span></p>
                            <p>UNOCCUPIED STATIONS: <span id="report-unoccupied-stations">0</span></p>
                            <button onclick="generateReport()" class="btn-success mt-2">GENERATE REPORT</button>
                        </div>
                    </div>
                </div>
                <div class="system-panel mt-4">
                    <h2 class="text-neon-blue text-2xl font-bold mb-4">CUSTOM REPORTS</h2>
                    <form id="custom-report-form">
                        <label for="report-start-date" class="text-neon-green">Start Date:</label>
                        <input type="date" id="report-start-date">
                        <label for="report-end-date" class="text-neon-green">End Date:</label>
                        <input type="date" id="report-end-date">
                        <label class="text-neon-green">Select Metrics:</label>
                        <div style="display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 1rem;">
                            <label><input type="checkbox" name="metric" value="mostUsed" checked> Most Used Stations</label>
                            <label><input type="checkbox" name="metric" value="leastUsed" checked> Least Used Stations</label>
                            <label><input type="checkbox" name="metric" value="averageSession"> Average Session Time</label>
                        </div>
                        <button type="submit" class="btn-primary w-full">GENERATE CUSTOM REPORT</button>
                    </form>
                    <div id="custom-report-output" class="report-section" style="display: none;"></div>
                </div>
                <div class="system-panel mt-4">
                    <h2 id="admin-station-status" class="text-neon-blue text-2xl font-bold mb-4">STATION STATUS</h2>
                    <div id="station-status-admin" class="grid-container"></div>
                </div>
                <div class="system-panel mt-4">
                    <h2 class="text-neon-blue text-2xl font-bold mb-4">EMERGENCY BROADCAST</h2>
                    <form id="broadcast-form">
                        <textarea id="broadcast-message-input" placeholder="Type urgent message here..." rows="2" required></textarea>
                        <button type="submit" class="btn-danger w-full mt-2">SEND BROADCAST</button>
                    </form>
                </div>
                <div class="system-panel mt-4">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <h2 class="text-neon-blue text-2xl font-bold">CHAT WITH SUPERVISORS</h2>
                        <span id="admin-chat-notification" class="blinking-dot" style="display:none;"></span>
                    </div>
                    <div id="admin-chat-box" class="chat-container"></div>
                    <form id="admin-chat-form" style="display:flex; gap: 1rem; margin-top: 1rem;">
                        <input type="text" id="admin-chat-input" placeholder="> TYPE MESSAGE..." style="flex-grow: 1;" required>
                        <button type="submit" class="btn-primary">SEND</button>
                    </form>
                </div>
            </div>
        </div>
        <div id="supervisor-dashboard" style="display:none;">
            
<div class="flex-container mt-2" id="supervisor-quick-nav">
    <div style="display:flex; gap:0.5rem; flex-wrap:wrap;">
        <button class="btn-primary" onclick="scrollToSection('sup-assign')">Assign Station</button>
        <button class="btn-primary" onclick="scrollToSection('sup-status')">Station Status</button>
        <button class="btn-primary" onclick="scrollToSection('sup-report')">Report Issue</button>
        <button class="btn-primary" onclick="scrollToSection('sup-chat')">Chat</button>
        <button class="btn-warning" onclick="toggleTheme()">Toggle Theme</button>
    </div>
</div>
<div class="system-panel">
                <div class="flex-container">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <div id="supervisor-profile-photo" style="width: 48px; height: 48px; border-radius: 50%; border: 1px dashed #00ff00; overflow: hidden; display: flex; align-items: center; justify-content: center; background: #333;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#00ff00" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                        </div>
                        <h1 class="text-neon-green text-3xl font-bold">SUPERVISOR DASHBOARD</h1>
                    </div>
                    <div style="display:flex; gap: 1rem;">
                        <button id="supervisor-change-password-btn" class="btn-primary">CHANGE PASSWORD</button>
                        <button id="supervisor-logout-btn" class="btn-danger">LOGOUT</button>
                    </div>
                </div>
                <div class="flex-container mt-4">
                    <div class="system-panel">
                        <h2 id="sup-assign" class="text-neon-green text-2xl font-bold mb-4">ASSIGN STATION</h2>
                        <form id="station-assignment-form">
                            <select id="station-select" required>
                                <option value="">SELECT A STATION</option>
                            </select>
                            <input type="text" id="student-lookup-input" placeholder="ENTER STUDENT ID OR NAME" required>
                            <div id="student-profile-preview" style="display: none; align-items: center; gap: 1rem; margin-top: 1rem;">
                                <img id="student-photo-preview" src="" alt="Student Photo" style="width: 64px; height: 64px; border-radius: 50%; object-fit: cover; border: 1px dashed #00ff00;">
                                <div id="student-details-preview"></div>
                            </div>
                            <label class="text-neon-green">Session Duration (minutes)</label>
                            <input type="number" id="session-duration" placeholder="e.g., 60" min="15" value="60" required>
                            <p id="station-assignment-message" class="text-center mt-2"></p>
                            <button type="submit" class="btn-success w-full mt-4">ASSIGN STATION</button>
                        </form>
                    </div>
                    <div class="system-panel">
                        <h2 id="sup-status" class="text-neon-green text-2xl font-bold mb-4">STATION STATUS</h2>
                        <div id="station-status-supervisor" class="grid-container"></div>
                    </div>
                </div>
                <div class="flex-container mt-4">
                    <div class="system-panel">
                        <h2 id="sup-report" class="text-neon-green text-2xl font-bold mb-4">REPORT STATION ISSUES</h2>
                        <form id="issue-report-form">
                            <select id="issue-station-select" required>
                                <option value="">SELECT STATION</option>
                            </select>
                            <select id="issue-type" required>
                                <option value="">SELECT ISSUE TYPE</option>
                                <option value="Needs Maintenance">Needs Maintenance</option>
                                <option value="Out of Service">Out of Service</option>
                            </select>
                            <textarea id="issue-description" placeholder="DESCRIBE THE ISSUE..." rows="4" required></textarea>
                            <button type="submit" class="btn-warning w-full mt-4">REPORT ISSUE</button>
                        </form>
                    </div>
                    <div class="system-panel">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <h2 id="sup-chat" class="text-neon-green text-2xl font-bold mb-4">CHAT WITH ADMIN</h2>
                            <span id="supervisor-chat-notification" class="blinking-dot" style="display:none;"></span>
                        </div>
                        <div id="supervisor-chat-box" class="chat-container"></div>
                        <form id="supervisor-chat-form" style="display:flex; gap: 1rem; margin-top: 1rem;">
                            <input type="text" id="supervisor-chat-input" placeholder="> REPLY TO ADMIN..." style="flex-grow: 1;" required>
                            <button type="submit" class="btn-success">REPLY</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <div id="kiosk-screen" style="display:none;">
            <div class="system-panel">
                <div class="flex-container">
                    <h1 class="text-neon-yellow text-3xl font-bold">STUDENT KIOSK</h1>
                    <button id="kiosk-back-btn" class="btn-warning">BACK TO LOGIN</button>
                </div>
                <div class="system-panel mt-4">
                    <h2 class="text-neon-yellow text-2xl font-bold mb-4">STATION STATUS OVERVIEW</h2>
                    <div id="kiosk-station-list" class="grid-container"></div>
                </div>
            </div>
        </div>
        <div id="password-reset-modal" class="message-box">
            <h3 class="text-neon-yellow text-2xl mb-4">RESET PASSWORD</h3>
            <form id="password-reset-form">
                <input type="text" id="reset-name" placeholder="Name" required>
                <input type="text" id="reset-id" placeholder="ID" required>
                <input type="password" id="reset-old-password" placeholder="Current Password" required>
                <input type="password" id="reset-new-password" placeholder="New Password" required>
                <button type="submit" class="btn-warning w-full mt-4">RESET PASSWORD</button>
                <button type="button" id="cancel-reset-btn" class="btn-danger w-full mt-2">CANCEL</button>
                <p id="reset-message" class="text-center text-neon-red mt-2"></p>
            </form>
        </div>
        <div id="password-change-modal" class="message-box">
            <h3 class="text-neon-blue text-2xl mb-4">CHANGE PASSWORD</h3>
            <form id="password-change-form">
                <input type="password" id="current-password" placeholder="Current Password" required>
                <input type="password" id="new-password" placeholder="New Password" required>
                <div id="new-password-strength" class="password-strength"></div>
                <button type="submit" class="btn-primary w-full mt-4">CHANGE PASSWORD</button>
                <button type="button" id="cancel-change-btn" class="btn-danger w-full mt-2">CANCEL</button>
                <p id="change-password-message" class="text-center text-neon-red mt-2"></p>
            </form>
        </div>
        <div id="user-detail-modal" class="message-box" style="max-width: 600px;">
            <h3 class="text-neon-blue text-2xl mb-4" id="user-modal-title"></h3>
            <form id="edit-user-form">
                <div id="user-modal-content"></div>
                <button type="submit" class="btn-primary w-full mt-4">SAVE CHANGES</button>
                <button type="button" onclick="closeModal('user-detail-modal')" class="btn-danger w-full mt-2">CLOSE</button>
            </form>
        </div>
    </div>

    <script>
        // ---------- Firebase Configuration ----------
        const firebaseConfig = {
          apiKey: "AIzaSyDrjo_HDQ1RRkjA-zXgZtuFovI7zg2yma0",
          authDomain: "kmu-digita-rsc-mnt-system.firebaseapp.com",
          databaseURL: "https://kmu-digita-rsc-mnt-system-default-rtdb.firebaseio.com",
          projectId: "kmu-digita-rsc-mnt-system",
          storageBucket: "kmu-digita-rsc-mnt-system.appspot.com",
          messagingSenderId: "908284620214",
          appId: "1:908284620214:web:e76e9a4757c162eea1a517",
          measurementId: "G-JEPQ1YMVNE"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        // ---------- Local state (minimal) ----------
        let currentUser = null; // { uid, role, name, id }
        let adminSettings = null; // loaded from meta/adminSettings doc

        // ---------- UI references ----------
        const loginScreen = document.getElementById('login-screen');
        const adminDashboard = document.getElementById('admin-dashboard');
        const supervisorDashboard = document.getElementById('supervisor-dashboard');
        const kioskScreen = document.getElementById('kiosk-screen');
        const adminLoginForm = document.getElementById('admin-login-form');
        const supervisorLoginForm = document.getElementById('supervisor-login-form');
        const showAdminLoginBtn = document.getElementById('show-admin-login-btn');
        const showSupervisorLoginBtn = document.getElementById('show-supervisor-login-btn');
        const showKioskBtn = document.getElementById('show-kiosk-btn');
        const kioskBackBtn = document.getElementById('kiosk-back-btn');
        const adminLoginMessage = document.getElementById('admin-login-message');
        const supervisorLoginMessage = document.getElementById('supervisor-login-message');
        const passwordResetModal = document.getElementById('password-reset-modal');
        const forgotPasswordBtn = document.getElementById('forgot-password-btn');
        const passwordResetForm = document.getElementById('password-reset-form');
        const cancelResetBtn = document.getElementById('cancel-reset-btn');
        const studentRegisterForm = document.getElementById('student-register-form');
        const supervisorRegisterForm = document.getElementById('supervisor-register-form');
        const supervisorRegPasswordInput = document.getElementById('supervisor-reg-password');
        const supervisorPasswordStrength = document.getElementById('supervisor-password-strength');
        const studentRegisterMessage = document.getElementById('student-register-message');
        const supervisorRegisterMessage = document.getElementById('supervisor-register-message');
        const userList = document.getElementById('user-list');
        const userSearchInput = document.getElementById('user-search-input');
        const activityLog = document.getElementById('activity-log');
        const stationStatusAdmin = document.getElementById('station-status-admin');
        const adminChatBox = document.getElementById('admin-chat-box');
        const adminChatForm = document.getElementById('admin-chat-form');
        const stationAssignmentForm = document.getElementById('station-assignment-form');
        const stationSelect = document.getElementById('station-select');
        const studentLookupInput = document.getElementById('student-lookup-input');
        const studentLookupMessage = document.getElementById('station-assignment-message');
        const studentProfilePreview = document.getElementById('student-profile-preview');
        const studentPhotoPreview = document.getElementById('student-photo-preview');
        const studentDetailsPreview = document.getElementById('student-details-preview');
        const stationStatusSupervisor = document.getElementById('station-status-supervisor');
        const issueReportForm = document.getElementById('issue-report-form');
        const issueStationSelect = document.getElementById('issue-station-select');
        const supervisorChatBox = document.getElementById('supervisor-chat-box');
        const supervisorChatForm = document.getElementById('supervisor-chat-form');
        const passwordChangeModal = document.getElementById('password-change-modal');
        const supervisorChangePasswordBtn = document.getElementById('supervisor-change-password-btn');
        const passwordChangeForm = document.getElementById('password-change-form');
        const cancelChangeBtn = document.getElementById('cancel-change-btn');
        const newPasswordInput = document.getElementById('new-password');
        const newPasswordStrength = document.getElementById('new-password-strength');
        const supervisorProfilePhoto = document.getElementById('supervisor-profile-photo');
        const welcomeMessage = document.getElementById('welcome-message');
        const broadcastMessageEl = document.getElementById('broadcast-message');
        const broadcastTextEl = document.getElementById('broadcast-text');
        const customReportForm = document.getElementById('custom-report-form');
        const customReportOutput = document.getElementById('custom-report-output');
        const broadcastForm = document.getElementById('broadcast-form');
        const userDetailModal = document.getElementById('user-detail-modal');
        const userModalTitle = document.getElementById('user-modal-title');
        const userModalContent = document.getElementById('user-modal-content');
        const kioskStationList = document.getElementById('kiosk-station-list');
        const adminChatNotification = document.getElementById('admin-chat-notification');
        const supervisorChatNotification = document.getElementById('supervisor-chat-notification');

        // ---------- Utility functions ----------
        function updateWelcomeMessage() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' };
            welcomeMessage.textContent = `SYSTEM ACCESS. CURRENT TIME: ${now.toLocaleDateString('en-US', options)}`;
        }
        function showScreen(screenId) {
            loginScreen.style.display = 'none';
            adminDashboard.style.display = 'none';
            supervisorDashboard.style.display = 'none';
            kioskScreen.style.display = 'none';
            document.getElementById(screenId).style.display = 'block';
            if (screenId === 'kiosk-screen') {
                // kiosk list updates from realtime listener
            }
        }

        // ---------- Initial seeding & listeners ----------
        async function ensureAdminSettings() {
            const docRef = db.collection('meta').doc('adminSettings');
            const doc = await docRef.get();
            if (!doc.exists) {
                // create default admin settings. You should update secret code & admin email via Firestore console
                await docRef.set({
                    email: 'admin@kmu.com',
                    username: 'Admin',
                    secretCode: '12345'
                });
            }
            adminSettings = (await docRef.get()).data();
        }

        async function ensureStationsExist(count = 100) {
            const stationsRef = db.collection('stations');
            const snapshot = await stationsRef.limit(1).get();
            if (snapshot.empty) {
                // create stations 1..count
                const batch = db.batch();
                for (let i = 1; i <= count; i++) {
                    const sRef = stationsRef.doc(String(i));
                    batch.set(sRef, {
                        id: i,
                        isOccupied: false,
                        assignedTo: null,
                        assignedBy: null,
                        issue: null,
                        sessionEndTime: null,
                        sessionDuration: null,
                        statusFlag: null
                    });
                }
                await batch.commit();
            }
        }

        // realtime listeners (students, supervisors, stations, chats, activities)
        let studentsCache = [];
        let supervisorsCache = [];
        function attachRealtimeListeners() {
            db.collection('students').onSnapshot(snapshot => {
                studentsCache = [];
                snapshot.forEach(doc => studentsCache.push({ id: doc.id, ...doc.data() }));
                renderUserList();
            });
            db.collection('supervisors').onSnapshot(snapshot => {
                supervisorsCache = [];
                snapshot.forEach(doc => supervisorsCache.push({ id: doc.id, ...doc.data() }));
                renderUserList();
                renderSupervisorProfile();
            });
            db.collection('stations').onSnapshot(snapshot => {
                // transform into array of stations sorted by id
                const stations = [];
                snapshot.forEach(doc => stations.push({ id: Number(doc.id), ...doc.data() }));
                stations.sort((a,b) => a.id - b.id);
                window._stationsCache = stations;
                renderStationStatusAdmin();
                renderStationStatusSupervisor();
                renderStationSelectors();
                renderKioskStations();
                updateReportCounts();
            });
            db.collection('chats').orderBy('time').onSnapshot(snapshot => {
                const messages = [];
                snapshot.forEach(doc => messages.push({ id: doc.id, ...doc.data() }));
                window._chatsCache = messages;
                renderChat(adminChatBox, 'admin');
                renderChat(supervisorChatBox, 'supervisor');
            });
            db.collection('activities').orderBy('time', 'desc').limit(50).onSnapshot(snapshot => {
                activityLog.innerHTML = '';
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const li = document.createElement('li');
                    const timeStr = new Date(data.time).toLocaleTimeString();
                    li.textContent = `[${timeStr}] ${data.message}`;
                    activityLog.prepend(li);
                });
            });
            // listen for broadcast message
            db.collection('meta').doc('broadcast').onSnapshot(doc => {
                if (doc.exists) {
                    const data = doc.data();
                    if (data && data.message) {
                        broadcastTextEl.textContent = data.message;
                        broadcastMessageEl.style.display = 'block';
                    } else {
                        broadcastMessageEl.style.display = 'none';
                    }
                } else {
                    broadcastMessageEl.style.display = 'none';
                }
            });
        }

        // ---------- Authentication & Login flows ----------
        showAdminLoginBtn.addEventListener('click', () => toggleLoginForms('admin'));
        showSupervisorLoginBtn.addEventListener('click', () => toggleLoginForms('supervisor'));
        showKioskBtn.addEventListener('click', () => showScreen('kiosk-screen'));
        kioskBackBtn.addEventListener('click', () => showScreen('login-screen'));

        function toggleLoginForms(formToShow) {
            const adminLogin = document.getElementById('admin-login-form');
            const supervisorLogin = document.getElementById('supervisor-login-form');
            const adminBtn = document.getElementById('show-admin-login-btn');
            const supervisorBtn = document.getElementById('show-supervisor-login-btn');
            if (formToShow === 'admin') {
                adminLogin.style.display = 'block';
                supervisorLogin.style.display = 'none';
                adminBtn.style.backgroundColor = '#00aaff';
                supervisorBtn.style.backgroundColor = '#00cc00';
            } else {
                supervisorLogin.style.display = 'block';
                adminLogin.style.display = 'none';
                supervisorBtn.style.backgroundColor = '#00aaff';
                adminBtn.style.backgroundColor = '#00cc00';
            }
        }

        adminLoginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            adminLoginMessage.textContent = '';
            const username = e.target['admin-username'].value.trim();
            const password = e.target['admin-password'].value;
            const secretCodeInput = e.target['admin-secret-code'].value.trim();
            try {
                const settingsRef = db.collection('meta').doc('adminSettings');
                const settingsDoc = await settingsRef.get();
                if (!settingsDoc.exists) {
                    adminLoginMessage.textContent = 'ADMIN SETTINGS NOT CONFIGURED. CHECK FIRESTORE meta/adminSettings.';
                    return;
                }
                adminSettings = settingsDoc.data();
                // check username and secret code, then sign in using the stored email
                if (username !== adminSettings.username) {
                    adminLoginMessage.textContent = 'INVALID USERNAME.';
                    return;
                }
                if (secretCodeInput !== String(adminSettings.secretCode)) {
                    adminLoginMessage.textContent = 'INVALID SECRET CODE.';
                    return;
                }
                // sign in with Firebase Auth using admin email
                await auth.signInWithEmailAndPassword(adminSettings.email, password);
                currentUser = { role: 'admin', uid: auth.currentUser.uid, name: adminSettings.username };
                showScreen('admin-dashboard');
                attachRealtimeListeners();
                logActivity('Admin logged in.');
            } catch (err) {
                console.error(err);
                adminLoginMessage.textContent = err.message || 'LOGIN FAILED.';
            }
        });

        supervisorLoginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            supervisorLoginMessage.textContent = '';
            const id = e.target['supervisor-id'].value.trim();
            const password = e.target['supervisor-password'].value;
            try {
                // find supervisor document by ID (we store supervisor reg-id in doc.id field)
                const supDoc = await db.collection('supervisors').doc(id).get();
                if (!supDoc.exists) {
                    supervisorLoginMessage.textContent = 'INVALID ID OR PASSWORD.';
                    return;
                }
                const sup = supDoc.data();
                if (sup.isBlocked) {
                    supervisorLoginMessage.textContent = 'THIS ACCOUNT IS BLOCKED. CONTACT ADMIN.';
                    return;
                }
                // We require supervisors to have an auth account (created at registration)
                if (!sup.authUid) {
                    supervisorLoginMessage.textContent = 'SUPERVISOR AUTH ACCOUNT NOT FOUND. CONTACT ADMIN.';
                    return;
                }
                
                // lockout check
                const now = Date.now();
                const lockUntil = sup.lockUntil ? sup.lockUntil.toMillis ? sup.lockUntil.toMillis() : sup.lockUntil : null;
                if (lockUntil && lockUntil > now) {
                    const mins = Math.ceil((lockUntil - now) / 60000);
                    supervisorLoginMessage.textContent = `ACCOUNT LOCKED. TRY AGAIN IN ${mins} MINUTE(S).`;
                    return;
                }
                // attempt sign in using their auth email stored
                await auth.signInWithEmailAndPassword(sup.email, password);
                // success: reset attempts
                await db.collection('supervisors').doc(id).update({ failedAttempts: 0, lockUntil: null });
                currentUser = { role: 'supervisor', uid: auth.currentUser.uid, id: id, name: sup.name, email: sup.email };
                await db.collection('meta').doc('supervisorOnDuty').set({ id, name: sup.name, email: sup.email, time: new Date() });
                showScreen('supervisor-dashboard');
                attachRealtimeListeners();
                logActivity(`Supervisor ${sup.name} logged in.`);

            } catch (err) {
                console.error(err);
                try {
                    const supRef = db.collection('supervisors').doc(e.target['supervisor-id'].value.trim());
                    const docx = await supRef.get();
                    if (docx.exists) {
                        const d = docx.data();
                        const attempts = (d.failedAttempts || 0) + 1;
                        let updates = { failedAttempts: attempts };
                        if (attempts >= 3) {
                            updates.lockUntil = new Date(Date.now() + 15*60000);
                        }
                        await supRef.update(updates);
                    }
                } catch (_e) {}
                supervisorLoginMessage.textContent = err.message || 'LOGIN FAILED.';
            }
        });

        // logout handlers
        document.getElementById('admin-logout-btn').addEventListener('click', async () => {
            await auth.signOut();
            currentUser = null;
            showScreen('login-screen');
            logActivity('Admin logged out.');
        });
        document.getElementById('supervisor-logout-btn').addEventListener('click', async () => {
            try { await db.collection('meta').doc('supervisorOnDuty').set({}); } catch(e){}
            await auth.signOut();
            logActivity(`Supervisor logged out.`);
            currentUser = null;
            showScreen('login-screen');
        });

        // ---------- Register student (upload photo to storage, save to Firestore) ----------
        studentRegisterForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            studentRegisterMessage.textContent = '';
            const name = e.target['student-name'].value.trim();
            const id = e.target['student-id'].value.trim();
            const hostel = e.target['student-hostel'].value.trim();
            const program = e.target['student-program'].value.trim();
            const year = e.target['student-year'].value;
            const photoFile = document.getElementById('student-photo').files[0];
            try {
                const studentRef = db.collection('students').doc(id);
                const exists = (await studentRef.get()).exists;
                if (exists) {
                    studentRegisterMessage.textContent = `ERROR: STUDENT WITH ID ${id} ALREADY EXISTS.`;
                    studentRegisterMessage.className = 'text-center mt-2 text-neon-red';
                    return;
                }
                let photoUrl = null;
                if (photoFile) {
                    const storageRef = storage.ref().child(`photos/students/${id}`);
                    await storageRef.put(photoFile);
                    photoUrl = await storageRef.getDownloadURL();
                }
                await studentRef.set({
                    name, id, hostel, program, year: Number(year), photo: photoUrl || null, stationHistory: []
                });
                studentRegisterForm.reset();
                studentRegisterMessage.textContent = `STUDENT ${name} REGISTERED SUCCESSFULLY!`;
                studentRegisterMessage.className = 'text-center mt-2 text-neon-green';
                logActivity(`ADMIN REGISTERED STUDENT ${name} (ID: ${id}).`);
            } catch (err) {
                console.error(err);
                studentRegisterMessage.textContent = err.message || 'FAILED TO REGISTER STUDENT.';
                studentRegisterMessage.className = 'text-center mt-2 text-neon-red';
            }
        });

        // ---------- Register supervisor (create Auth user + Firestore doc) ----------
        supervisorRegisterForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            supervisorRegisterMessage.textContent = '';
            const name = e.target['supervisor-name'].value.trim();
            const regId = e.target['supervisor-reg-id'].value.trim();
            const email = e.target['supervisor-email'].value.trim();
            const password = e.target['supervisor-reg-password'].value;
            const photoFile = document.getElementById('supervisor-photo').files[0];
            try {
                const supRef = db.collection('supervisors').doc(regId);
                const exists = (await supRef.get()).exists;
                if (exists) {
                    supervisorRegisterMessage.textContent = `ERROR: SUPERVISOR WITH ID ${regId} ALREADY EXISTS.`;
                    supervisorRegisterMessage.className = 'text-center mt-2 text-neon-red';
                    return;
                }
                // create auth user
                const userCred = await auth.createUserWithEmailAndPassword(email, password);
                const authUid = userCred.user.uid;
                let photoUrl = null;
                if (photoFile) {
                    const storageRef = storage.ref().child(`photos/supervisors/${regId}`);
                    await storageRef.put(photoFile);
                    photoUrl = await storageRef.getDownloadURL();
                }
                await supRef.set({
                    name, id: regId, email, photo: photoUrl || null, isBlocked: false, authUid
                });
                supervisorRegisterForm.reset();
                supervisorPasswordStrength.textContent = '';
                supervisorRegisterMessage.textContent = `SUPERVISOR ${name} REGISTERED SUCCESSFULLY!`;
                supervisorRegisterMessage.className = 'text-center mt-2 text-neon-green';
                logActivity(`ADMIN REGISTERED NEW SUPERVISOR ${name} (ID: ${regId}).`);
            } catch (err) {
                console.error(err);
                supervisorRegisterMessage.textContent = err.message || 'FAILED TO REGISTER SUPERVISOR.';
                supervisorRegisterMessage.className = 'text-center mt-2 text-neon-red';
            }
        });

        // ---------- Render user list (students + supervisors) ----------
        userSearchInput.addEventListener('input', () => renderUserList());
        function renderUserList() {
            userList.innerHTML = '';
            const searchTerm = (userSearchInput.value || '').toLowerCase();
            const allUsers = [...studentsCache, ...supervisorsCache];
            const filteredUsers = allUsers.filter(user => (user.name || '').toLowerCase().includes(searchTerm) || (user.id || '').toLowerCase().includes(searchTerm));
            filteredUsers.forEach(user => {
                const userItem = document.createElement('div');
                userItem.className = 'system-panel flex-container';
                const photoHtml = user.photo ? `<img src="${user.photo}" alt="${user.name}" style="width: 48px; height: 48px; border-radius: 50%; object-fit: cover; border: 1px dashed #00ff00;">` : `<div style="width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; background: #333; border-radius: 50%;">N/A</div>`;
                const userType = user.hasOwnProperty('program') ? 'Student' : 'Supervisor';
                const statusHtml = user.isBlocked ? `<p class="text-xs text-neon-red">BLOCKED</p>` : `<p class="text-xs text-neon-green">ACTIVE</p>`;
                userItem.innerHTML = `
                    <div style="display:flex; gap: 1rem; align-items: center;">
                        ${photoHtml}
                        <div>
                            <p class="text-xl">${user.name} (${user.id})</p>
                            <p class="text-sm">${userType}: ${user.email || user.program}</p>
                            ${userType === 'Supervisor' ? statusHtml : ''}
                        </div>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        ${userType === 'Supervisor' ? `
                            <button onclick="toggleSupervisorBlock('${user.id}')" class="btn-warning" style="background-color: ${user.isBlocked ? '#00cc00' : '#ffff33'}; border-color: ${user.isBlocked ? '#00cc00' : '#ffff33'}; color: #000;">
                                ${user.isBlocked ? 'UNBLOCK' : 'BLOCK'}
                            </button>
                        ` : ''}
                        <button onclick="showUserDetail('${user.id}', '${userType.toLowerCase()}')" class="btn-primary" style="background-color: #00aaff; border-color: #00aaff; color: #000;">VIEW / EDIT</button>
                        <button onclick="deleteUser('${user.id}', '${userType.toLowerCase()}')" class="btn-danger" style="background-color: #ff3333; border-color: #ff3333; color: #000;">DELETE</button>
                    </div>
                `;
                userList.appendChild(userItem);
            });
        }

        window.showUserDetail = async (id, type) => {
            let user;
            if (type === 'student') {
                const doc = await db.collection('students').doc(id).get();
                if (!doc.exists) return;
                user = { id: doc.id, ...doc.data() };
            } else {
                const doc = await db.collection('supervisors').doc(id).get();
                if (!doc.exists) return;
                user = { id: doc.id, ...doc.data() };
            }
            userModalTitle.textContent = `${type.toUpperCase()} PROFILE: ${user.name}`;
            let contentHtml = `<input type="hidden" id="edit-user-id" value="${user.id}">`;
            contentHtml += `<input type="hidden" id="edit-user-type" value="${type}">`;
            contentHtml += `<label class="text-neon-green">Name:</label><input type="text" id="edit-name" value="${user.name}" required>`;
            contentHtml += `<label class="text-neon-green">ID:</label><input type="text" value="${user.id}" disabled>`;
            if (type === 'student') {
                contentHtml += `<label class="text-neon-green">Hostel:</label><input type="text" id="edit-hostel" value="${user.hostel || ''}" required>`;
                contentHtml += `<label class="text-neon-green">Program:</label><input type="text" id="edit-program" value="${user.program || ''}" required>`;
                contentHtml += `<label class="text-neon-green">Year:</label><input type="number" id="edit-year" value="${user.year || ''}" required>`;
                contentHtml += `<h4 class="text-xl text-neon-yellow mt-4">STATION USAGE HISTORY:</h4><ul style="height: 150px; overflow-y: auto; border: 1px dashed #ffff33; padding: 1rem;">`;
                if (user.stationHistory && user.stationHistory.length > 0) {
                    user.stationHistory.forEach(hist => {
                        contentHtml += `<li>STATION ${hist.stationId} | ASSIGNED: ${new Date(hist.startTime).toLocaleString()}</li>`;
                    });
                } else {
                    contentHtml += `<li>NO USAGE HISTORY FOUND.</li>`;
                }
                contentHtml += `</ul>`;
            } else {
                contentHtml += `<label class="text-neon-green">Email:</label><input type="email" id="edit-email" value="${user.email || ''}" required>`;
                contentHtml += `<h4 class="text-xl text-neon-yellow mt-4">ASSIGNED STUDENTS:</h4><ul style="height: 150px; overflow-y: auto; border: 1px dashed #ffff33; padding: 1rem;">`;
                // assigned students will be queried
                const assignedSnapshot = await db.collection('stations').where('assignedBy', '==', user.name).where('isOccupied', '==', true).get();
                if (!assignedSnapshot.empty) {
                    assignedSnapshot.forEach(st => {
                        const stData = st.data();
                        contentHtml += `<li>STATION ${stData.id}: ${stData.assignedTo ? stData.assignedTo.name : 'N/A'}</li>`;
                    });
                } else {
                    contentHtml += `<li>NO STUDENTS CURRENTLY ASSIGNED.</li>`;
                }
                contentHtml += `</ul>`;
            }
            userModalContent.innerHTML = contentHtml;
            userDetailModal.style.display = 'block';
        };

        document.getElementById('edit-user-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = e.target['edit-user-id'].value;
            const type = e.target['edit-user-type'].value;
            if (type === 'student') {
                const studentRef = db.collection('students').doc(id);
                await studentRef.update({
                    name: e.target['edit-name'].value,
                    hostel: document.getElementById('edit-hostel').value,
                    program: document.getElementById('edit-program').value,
                    year: Number(document.getElementById('edit-year').value)
                });
                logActivity(`ADMIN UPDATED STUDENT ${id}'s details.`);
            } else {
                const supRef = db.collection('supervisors').doc(id);
                await supRef.update({
                    name: e.target['edit-name'].value,
                    email: document.getElementById('edit-email').value
                });
                logActivity(`ADMIN UPDATED SUPERVISOR ${id}'s details.`);
            }
            closeModal('user-detail-modal');
        });

        window.closeModal = (id) => {
            document.getElementById(id).style.display = 'none';
        };

        window.toggleSupervisorBlock = async (id) => {
            const supRef = db.collection('supervisors').doc(id);
            const doc = await supRef.get();
            if (!doc.exists) return;
            const isBlocked = !!doc.data().isBlocked;
            await supRef.update({ isBlocked: !isBlocked });
            logActivity(`ADMIN ${!isBlocked ? 'BLOCKED' : 'UNBLOCKED'} SUPERVISOR ${doc.data().name}.`);
        };

        window.deleteUser = async (id, type) => {
            if (type === 'student') {
                await db.collection('students').doc(id).delete();
                logActivity(`ADMIN DELETED STUDENT (ID: ${id}).`);
            } else {
                const supDoc = await db.collection('supervisors').doc(id).get();
                if (supDoc.exists) {
                    const sup = supDoc.data();
                    // try delete auth account if authUid present
                    if (sup.authUid) {
                        try {
                            // Note: deleting other auth users requires admin privileges (server). We cannot delete another auth user from client SDK.
                            // So here we only remove the Firestore doc and leave auth user for manual removal using Firebase Console or Cloud Function.
                        } catch (err) {
                            console.warn('Could not delete auth user from client:', err);
                        }
                    }
                    await db.collection('supervisors').doc(id).delete();
                    logActivity(`ADMIN DELETED SUPERVISOR ${sup.name} (ID: ${id}).`);
                }
            }
        };

        // ---------- Station rendering & assignment ----------
        function renderStationStatusAdmin() {
            stationStatusAdmin.innerHTML = '';
            const stations = window._stationsCache || [];
            stations.forEach(station => {
                let statusClass = station.isOccupied ? 'occupied' : 'unoccupied';
                if (station.statusFlag) statusClass = 'needs-maintenance';
                const statusText = station.isOccupied ? 'OCCUPIED' : (station.statusFlag ? station.statusFlag.toUpperCase() : 'UNOCCUPIED');
                const assignedDetails = station.isOccupied ? `
                    <p class="text-sm">ASSIGNED TO: ${station.assignedTo ? station.assignedTo.name : 'N/A'}</p>
                    <p class="text-sm">ASSIGNED BY: ${station.assignedBy || 'N/A'}</p><p class="text-sm" style="font-weight:bold;">OCCUPIED BY: ${station.assignedTo ? station.assignedTo.name : 'N/A'}</p>
                    <p class="text-sm">TIME LEFT: <span id="timer-${station.id}-admin">--:--</span></p>
                    <button onclick="unassignStation(${station.id}, 'admin')" class="btn-danger w-full mt-2" style="font-size: 0.75rem; padding: 0.25rem;">UNASSIGN</button>
                ` : '';
                const issueDetails = station.issue ? `<p class="text-xs text-neon-yellow mt-2">ISSUE: ${station.issue}</p><button onclick="dismissIssue(${station.id})" class="btn-warning" style="font-size:0.75rem; padding:0.25rem;">DISMISS ISSUE</button>` : '';
                const stationCard = document.createElement('div');
                stationCard.className = `station-card ${statusClass}`;
                stationCard.innerHTML = `
                    <h3 class="text-xl font-bold">STATION ${station.id}</h3>
                    <p class="text-sm font-bold">${statusText}</p>
                    ${assignedDetails}
                    ${issueDetails}
                `;
                stationStatusAdmin.appendChild(stationCard);
            });
        }

        async function unassignStation(id, unassignedBy) {
            const sRef = db.collection('stations').doc(String(id));
            const sDoc = await sRef.get();
            if (!sDoc.exists) return;
            const s = sDoc.data();
            if (!s.isOccupied) return;
            // update student's history
            if (s.assignedTo && s.assignedTo.id) {
                const stuRef = db.collection('students').doc(s.assignedTo.id);
                const stuDoc = await stuRef.get();
                if (stuDoc.exists) {
                    const stu = stuDoc.data();
                    const hist = stu.stationHistory || [];
                    const startTime = s.sessionEndTime ? (s.sessionEndTime - (s.sessionDuration || 0)*60000) : Date.now();
                    hist.push({ stationId: s.id, startTime: new Date(startTime).toISOString(), endTime: new Date().toISOString() });
                    await stuRef.update({ stationHistory: hist });
                }
            }
            // push to stationUsage collection
            await db.collection('stationUsageHistory').add({
                stationId: s.id,
                studentId: s.assignedTo ? s.assignedTo.id : null,
                startTime: s.sessionEndTime ? (new Date(s.sessionEndTime - (s.sessionDuration || 0)*60000)).toISOString() : new Date().toISOString(),
                endTime: new Date().toISOString(),
                duration: s.sessionDuration || null,
                timestamp: new Date()
            });
            await sRef.update({
                isOccupied: false,
                assignedTo: null,
                assignedBy: null,
                sessionEndTime: null,
                sessionDuration: null,
                issue: null,
                statusFlag: null
            });
            alert(`STATION ${id} HAS BEEN UNASSIGNED.`);
            logActivity(`${unassignedBy.toUpperCase()} UNASSIGNED STATION ${id}.`);
        }

        function renderStationSelectors() {
            stationSelect.innerHTML = '<option value="">SELECT A STATION</option>';
            issueStationSelect.innerHTML = '<option value="">SELECT A STATION</option>';
            const stations = window._stationsCache || [];
            stations.forEach(station => {
                const option = document.createElement('option');
                option.value = station.id;
                option.textContent = `STATION ${station.id}`;
                if (station.isOccupied) {
                    option.disabled = true;
                    option.textContent += ' (OCCUPIED)';
                }
                stationSelect.appendChild(option);
                const issueOption = document.createElement('option');
                issueOption.value = station.id;
                issueOption.textContent = `STATION ${station.id}`;
                if (station.statusFlag) issueOption.textContent += ` (${station.statusFlag})`;
                issueStationSelect.appendChild(issueOption);
            });
        }

        studentLookupInput.addEventListener('input', async () => {
            const value = studentLookupInput.value.trim();
            if (!value) {
                studentProfilePreview.style.display = 'none';
                return;
            }
            // try find by id then by name
            let student = null;
            const doc = await db.collection('students').doc(value).get();
            if (doc.exists) student = { id: doc.id, ...doc.data() };
            else {
                const snap = await db.collection('students').where('name', '==', value).limit(1).get();
                if (!snap.empty) {
                    const sd = snap.docs[0];
                    student = { id: sd.id, ...sd.data() };
                }
            }
            if (student) {
                studentProfilePreview.style.display = 'flex';
                studentPhotoPreview.src = student.photo || 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDgiIGhlaWdodD0iMTA4IiB2aWV3Qm94PSIwIDAgMjQgMjQiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzAwZmYwMCIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiIGNsYXNzPSJsdWNpZGUgbHVjaWRlLXVzZXIiPjxwYXRoIGQ9Ik0xOSAyMXYtMmE0IDQgMCAwIDAtNC00SDlhNCA0IDAgMCAwLTQgNHYyIi8+PGNpcmNsZSBjeD0iMTIiIGN5PSI3IiByPSI0Ii8+PC9zdmc+';
                studentDetailsPreview.innerHTML = `
                    <p class="text-xl text-neon-green">${student.name}</p>
                    <p class="text-sm">ID: ${student.id}</p>
                    <p class="text-sm">Hostel: ${student.hostel}</p>
                `;
                studentLookupMessage.textContent = '';
            } else {
                studentProfilePreview.style.display = 'none';
                studentLookupMessage.textContent = 'STUDENT NOT FOUND. PLEASE CHECK THE ID OR NAME.';
                studentLookupMessage.className = 'text-center text-neon-red mt-2';
            }
        });

        stationAssignmentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const stationId = parseInt(e.target['station-select'].value);
            const studentLookup = e.target['student-lookup-input'].value.trim();
            const duration = parseInt(e.target['session-duration'].value);
            if (!studentLookup) {
                studentLookupMessage.textContent = 'ENTER STUDENT ID OR NAME.';
                return;
            }
            // find student
            let student = null;
            const doc = await db.collection('students').doc(studentLookup).get();
            if (doc.exists) student = { id: doc.id, ...doc.data() };
            else {
                const snap = await db.collection('students').where('name', '==', studentLookup).limit(1).get();
                if (!snap.empty) {
                    student = { id: snap.docs[0].id, ...snap.docs[0].data() };
                }
            }
            if (!student) {
                studentLookupMessage.textContent = 'ERROR: STUDENT DOES NOT EXIST IN THE SYSTEM.';
                studentLookupMessage.className = 'text-center text-neon-red mt-2';
                return;
            }
            const sRef = db.collection('stations').doc(String(stationId));
            const sDoc = await sRef.get();
            if (!sDoc.exists) {
                studentLookupMessage.textContent = 'INVALID STATION.';
                studentLookupMessage.className = 'text-center text-neon-red mt-2';
                return;
            }
            const s = sDoc.data();
            if (s.isOccupied) {
                studentLookupMessage.textContent = 'STATION IS ALREADY OCCUPIED.';
                studentLookupMessage.className = 'text-center text-neon-red mt-2';
                return;
            }
            // assign station
            await sRef.update({
                isOccupied: true,
                assignedTo: { id: student.id, name: student.name },
                assignedBy: currentUser.name || 'Supervisor',
                sessionEndTime: Date.now() + duration*60000,
                sessionDuration: duration
            });
            studentLookupMessage.textContent = `SUCCESS: STATION ${stationId} ASSIGNED TO ${student.name}.`;
            studentLookupMessage.className = 'text-center mt-2 text-neon-green';
            stationAssignmentForm.reset();
            studentProfilePreview.style.display = 'none';
            logActivity(`SUPERVISOR ${currentUser.name || 'unknown'} ASSIGNED STATION ${stationId} TO ${student.name} for ${duration} minutes.`);
            await db.collection('assignments').add({stationId, studentId: student.id, studentName: student.name, supervisorId: currentUser.id, supervisorName: currentUser.name, time: new Date(), duration});
        });

        function renderStationStatusSupervisor() {
            stationStatusSupervisor.innerHTML = '';
            const stations = window._stationsCache || [];
            stations.forEach(station => {
                let statusClass = station.isOccupied ? 'occupied' : 'unoccupied';
                if (station.statusFlag) statusClass = 'needs-maintenance';
                const statusText = station.isOccupied ? 'OCCUPIED' : (station.statusFlag ? station.statusFlag.toUpperCase() : 'UNOCCUPIED');
                const assignedDetails = station.isOccupied ? `
                    <p class="text-sm">BY: ${station.assignedTo ? station.assignedTo.name : 'N/A'}</p>
                    <p class="text-sm">TIME LEFT: <span id="timer-${station.id}-supervisor">--:--</span></p>
                    <button onclick="unassignStation(${station.id}, 'supervisor')" class="btn-danger w-full mt-2" style="font-size: 0.75rem; padding: 0.25rem;">UNASSIGN</button>
                ` : '';
                const issueDetails = station.issue ? `<p class="text-xs text-neon-yellow mt-2">ISSUE: ${station.issue}</p><button onclick="dismissIssue(${station.id})" class="btn-warning" style="font-size:0.75rem; padding:0.25rem;">DISMISS ISSUE</button>` : '';
                const stationCard = document.createElement('div');
                stationCard.className = `station-card ${statusClass}`;
                stationCard.innerHTML = `
                    <h3 class="text-xl font-bold">STATION ${station.id}</h3>
                    <p class="text-sm font-bold">${statusText}</p>
                    ${assignedDetails}
                    ${issueDetails}
                `;
                stationStatusSupervisor.appendChild(stationCard);
            });
        }

        issueReportForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const stationId = parseInt(e.target['issue-station-select'].value);
            const statusFlag = e.target['issue-type'].value;
            const description = e.target['issue-description'].value;
            const sRef = db.collection('stations').doc(String(stationId));
            const sDoc = await sRef.get();
            if (!sDoc.exists) {
                alert('INVALID STATION SELECTED.');
                return;
            }
            await sRef.update({ statusFlag, issue: description });
            await db.collection('maintenanceLog').add({
                stationId, reportedBy: currentUser.name || 'unknown', statusFlag, description, date: new Date()
            });
            alert(`ISSUE REPORTED FOR STATION ${stationId}: ${description}`);
            issueReportForm.reset();
            logActivity(`SUPERVISOR ${currentUser.name || 'unknown'} REPORTED AN ISSUE WITH STATION ${stationId} (${statusFlag}).`);
        });

        supervisorChangePasswordBtn.addEventListener('click', () => {
            passwordChangeModal.style.display = 'block';
        });
        cancelChangeBtn.addEventListener('click', () => {
            passwordChangeModal.style.display = 'none';
        });
        passwordChangeForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const currentPassword = e.target['current-password'].value;
            const newPassword = e.target['new-password'].value;
            const changePasswordMessage = document.getElementById('change-password-message');
            try {
                const user = auth.currentUser;
                if (!user) throw new Error('Not authenticated');
                // Re-authenticate and change password
                const cred = firebase.auth.EmailAuthProvider.credential(user.email, currentPassword);
                await user.reauthenticateWithCredential(cred);
                await user.updatePassword(newPassword);
                passwordChangeModal.style.display = 'none';
                changePasswordMessage.textContent = '';
                alert('PASSWORD CHANGED SUCCESSFULLY!');
                logActivity(`PASSWORD FOR SUPERVISOR WAS CHANGED.`);
            } catch (err) {
                console.error(err);
                changePasswordMessage.textContent = err.message || 'FAILED TO CHANGE PASSWORD.';
            }
        });

        // ---------- Kiosk rendering ----------
        function renderKioskStations() {
            kioskStationList.innerHTML = '';
            const stations = window._stationsCache || [];
            stations.forEach(station => {
                let statusClass = station.isOccupied ? 'occupied' : 'unoccupied';
                if (station.statusFlag) statusClass = 'needs-maintenance';
                const statusText = station.isOccupied ? 'OCCUPIED' : (station.statusFlag ? station.statusFlag.toUpperCase() : 'UNOCCUPIED');
                const stationCard = document.createElement('div');
                stationCard.className = `kiosk-card station-card ${statusClass}`;
                stationCard.innerHTML = `
                    <h3 class="text-xl font-bold">STATION ${station.id}</h3>
                    <p class="text-sm font-bold">${statusText}</p>
                `;
                kioskStationList.appendChild(stationCard);
            });
        }

        // ---------- Timers & utility updates ----------
        let sessionTimerInterval = null;
        function startSessionTimers() {
            if (sessionTimerInterval) clearInterval(sessionTimerInterval);
            sessionTimerInterval = setInterval(() => {
                const now = Date.now();
                const stations = window._stationsCache || [];
                stations.forEach(station => {
                    if (station.isOccupied && station.sessionEndTime) {
                        const timeLeftMs = station.sessionEndTime - now;
                        if (timeLeftMs <= 0) {
                            // auto unassign
                            unassignStation(station.id, 'auto-timer');
                        } else {
                            const minutes = Math.floor(timeLeftMs / 60000);
                            const seconds = Math.floor((timeLeftMs % 60000) / 1000);
                            const timerElAdmin = document.getElementById(`timer-${station.id}-admin`);
                            if (timerElAdmin) timerElAdmin.textContent = `${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`;
                            const timerElSupervisor = document.getElementById(`timer-${station.id}-supervisor`);
                            if (timerElSupervisor) timerElSupervisor.textContent = `${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`;
                        }
                    }
                });
            }, 1000);
        }

        // ---------- Chat (Firestore-backed) ----------
        function renderChat(chatBox, userRole) {
            chatBox.innerHTML = '';
            const messages = window._chatsCache || [];
            messages.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `chat-message ${msg.role === 'admin' ? 'admin' : 'supervisor'}`;
                messageDiv.innerHTML = `<p class="font-bold">${msg.sender}:</p><p>${msg.text}</p><p style="text-align: right; font-size: 0.75rem; opacity: 0.7;">${new Date(msg.time).toLocaleTimeString()}</p>`;
                chatBox.appendChild(messageDiv);
            });
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        adminChatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const input = document.getElementById('admin-chat-input');
            const text = input.value.trim();
            if (!text) return;
            await db.collection('chats').add({
                sender: 'ADMIN',
                role: 'admin',
                text,
                time: Date.now()
            });
            input.value = '';
        });

        supervisorChatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const input = document.getElementById('supervisor-chat-input');
            const text = input.value.trim();
            if (!text) return;
            await db.collection('chats').add({
                sender: currentUser.name || 'SUPERVISOR',
                role: 'supervisor',
                text,
                time: Date.now()
            });
            input.value = '';
        });

        // ---------- Broadcast ----------
        broadcastForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const message = e.target['broadcast-message-input'].value.trim();
            if (!message) return;
            await db.collection('meta').doc('broadcast').set({ message, time: Date.now() });
            e.target.reset();
            logActivity(`ADMIN SENT AN EMERGENCY BROADCAST: "${message}"`);
        });
        window.dismissBroadcast = async () => {
            await db.collection('meta').doc('broadcast').delete();
            broadcastMessageEl.style.display = 'none';
        };

        // ---------- Activities logging ----------
        async function logActivity(message) {
            await db.collection('activities').add({ message, time: Date.now() });
        }

        // ---------- Reports ----------
        function updateReportCounts() {
            const stations = window._stationsCache || [];
            const totalStations = stations.length;
            const occupiedStations = stations.filter(s=>s.isOccupied).length;
            const unoccupiedStations = totalStations - occupiedStations;
            document.getElementById('report-supervisors').textContent = supervisorsCache.length;
            document.getElementById('report-students').textContent = studentsCache.length;
            document.getElementById('report-total-stations').textContent = totalStations;
            document.getElementById('report-occupied-stations').textContent = occupiedStations;
            document.getElementById('report-unoccupied-stations').textContent = unoccupiedStations;
        }

        customReportForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const startDate = e.target['report-start-date'].value ? new Date(e.target['report-start-date'].value) : null;
            const endDate = e.target['report-end-date'].value ? new Date(e.target['report-end-date'].value) : null;
            const metrics = Array.from(e.target.querySelectorAll('input[name="metric"]:checked')).map(cb => cb.value);
            let reportHtml = '<h3>CUSTOM REPORT</h3>';
            if (startDate && endDate) reportHtml += `<p>Date Range: ${startDate.toDateString()} to ${endDate.toDateString()}</p>`;
            // fetch stationUsageHistory and filter
            const snap = await db.collection('stationUsageHistory').get();
            const history = [];
            snap.forEach(d => history.push(d.data()));
            const filtered = history.filter(h => {
                if (startDate && endDate) {
                    const st = new Date(h.startTime);
                    return st >= startDate && st <= endDate;
                }
                return true;
            });
            if (metrics.includes('mostUsed') || metrics.includes('leastUsed')) {
                const usageCounts = filtered.reduce((acc,curr)=>{ acc[curr.stationId]=(acc[curr.stationId]||0)+1; return acc; }, {});
                const sorted = Object.entries(usageCounts).sort(([,a],[,b])=>b-a);
                if (metrics.includes('mostUsed')) {
                    reportHtml += `<h4>MOST USED STATIONS:</h4><ol>`;
                    sorted.slice(0,5).forEach(([stationId,count])=> reportHtml += `<li>STATION ${stationId}: ${count} TIMES</li>`);
                    reportHtml += `</ol>`;
                }
                if (metrics.includes('leastUsed')) {
                    const least = sorted.slice(-5).reverse();
                    reportHtml += `<h4>LEAST USED STATIONS:</h4><ol>`;
                    least.forEach(([stationId,count])=> reportHtml += `<li>STATION ${stationId}: ${count} TIMES</li>`);
                    reportHtml += `</ol>`;
                }
            }
            if (metrics.includes('averageSession')) {
                const totalDuration = filtered.reduce((sum,h)=> sum + (h.duration||0), 0);
                const avg = filtered.length>0 ? (totalDuration/filtered.length).toFixed(2) : 0;
                reportHtml += `<h4>AVERAGE SESSION TIME:</h4><p>${avg} MINUTES</p>`;
            }
            customReportOutput.innerHTML = reportHtml;
            customReportOutput.style.display = 'block';
            logActivity('ADMIN GENERATED A CUSTOM REPORT.');
        });

        // ---------- Password strength ----------
        function checkPasswordStrength(password, element) {
            const strongRegex = new RegExp("^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[!@#\\$%\\^&\\*])(?=.{8,})");
            const mediumRegex = new RegExp("^(((?=.*[a-z])(?=.*[A-Z]))|((?=.*[a-z])(?=.*[0-9]))|((?=.*[A-Z])(?=.*[0-9])))(?=.{6,})");
            if (strongRegex.test(password)) {
                element.textContent = 'Strong';
                element.className = 'password-strength strong';
            } else if (mediumRegex.test(password)) {
                element.textContent = 'Medium';
                element.className = 'password-strength medium';
            } else {
                element.textContent = 'Weak';
                element.className = 'password-strength weak';
            }
        }
        supervisorRegPasswordInput.addEventListener('input', (e)=> checkPasswordStrength(e.target.value, supervisorPasswordStrength));
        passwordChangeForm.addEventListener('input', (e) => {
            if (e.target.id === 'new-password') checkPasswordStrength(e.target.value, newPasswordStrength);
        });

        // ---------- Initialization on DOMContentLoaded ----------
        document.addEventListener('DOMContentLoaded', async () => {
            updateWelcomeMessage();
            toggleLoginForms('admin');
            await ensureAdminSettings();
            await ensureStationsExist(100); // keep original count (100)
            attachRealtimeListeners();
            startSessionTimers();
            
// add back-to-top buttons to each section
document.querySelectorAll('.system-panel').forEach(panel => {
    const btn = document.createElement('button');
    btn.textContent = 'Back to Top';
    btn.className = 'btn-primary';
    btn.style.marginTop = '0.5rem';
    btn.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));
    panel.appendChild(btn);
});

        });
    
        // Smooth scroll helper
        function scrollToSection(id) {
            const el = document.getElementById(id);
            if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        // Theme toggle
        function toggleTheme() {
            const isLight = document.body.classList.toggle('light-mode');
            localStorage.setItem('prefersLight', isLight ? '1' : '0');
        }
        (function initTheme(){
            const pref = localStorage.getItem('prefersLight');
            if (pref === '1') document.body.classList.add('light-mode');
        })();
        // Dismiss issue (admin)
        window.dismissIssue = async (stationId) => {
            await db.collection('stations').doc(String(stationId)).update({ statusFlag: null, issue: null });
            logActivity(`ADMIN DISMISSED ISSUE ON STATION ${stationId}.`);
        };
        // Update supervisor on duty (admin listener)
        (function listenOnDuty(){
            db.collection('meta').doc('supervisorOnDuty').onSnapshot(doc=>{
                const el = document.getElementById('supervisor-on-duty-details');
                if (!el) return;
                if (doc.exists && doc.data() && doc.data().name) {
                    const d = doc.data();
                    el.textContent = `${d.name} (ID: ${d.id}, Email: ${d.email || 'N/A'})`;
                } else {
                    el.textContent = 'None';
                }
            });
        })();
</script>
</body>
</html>
